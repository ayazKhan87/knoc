<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Profile - Knoc (Debug)</title>
    <meta name="description" content="Shop profile and products on Knoc">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom CSS -->
    <style>
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #1f2937;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-width: 400px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .debug-panel.hidden {
            display: none;
        }
        
        .debug-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10000;
        }
        
        .debug-section {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #374151;
        }
        
        .debug-section:last-child {
            border-bottom: none;
        }
        
        .debug-title {
            color: #60a5fa;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .debug-success {
            color: #10b981;
        }
        
        .debug-error {
            color: #ef4444;
        }
        
        .debug-warning {
            color: #f59e0b;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .product-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Debug Panel -->
    <button class="debug-toggle" onclick="toggleDebugPanel()">üêõ Debug</button>
    <div id="debug-panel" class="debug-panel hidden">
        <div class="debug-section">
            <div class="debug-title">URL Parameters</div>
            <div id="debug-params"></div>
        </div>
        <div class="debug-section">
            <div class="debug-title">API Request</div>
            <div id="debug-api"></div>
        </div>
        <div class="debug-section">
            <div class="debug-title">Response</div>
            <div id="debug-response"></div>
        </div>
        <div class="debug-section">
            <div class="debug-title">Errors</div>
            <div id="debug-errors"></div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="min-h-screen">
        <div class="loading-shimmer h-48 w-full"></div>
        <div class="p-4 space-y-4">
            <div class="loading-shimmer h-20 w-20 rounded-full mx-auto"></div>
            <div class="loading-shimmer h-6 w-48 mx-auto rounded"></div>
            <div class="loading-shimmer h-4 w-64 mx-auto rounded"></div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="content" class="hidden min-h-screen">
        <!-- Header Section -->
        <div class="relative">
            <!-- Cover Image -->
            <div id="cover-section" class="h-48 gradient-bg relative overflow-hidden">
                <img id="cover-image" class="w-full h-full object-cover hidden" alt="Shop Cover">
                <div class="absolute inset-0 bg-black bg-opacity-30"></div>
                
                <!-- Back Button -->
                <button onclick="history.back()" class="absolute top-4 left-4 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full p-2 transition-all">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Profile Section -->
            <div class="relative px-4 pb-6">
                <!-- Profile Image -->
                <div class="absolute -top-10 left-1/2 transform -translate-x-1/2">
                    <div class="w-20 h-20 rounded-full border-4 border-white bg-gray-200 overflow-hidden shadow-lg">
                        <img id="profile-image" class="w-full h-full object-cover" alt="Shop Logo">
                    </div>
                    <div class="absolute bottom-1 right-1 w-4 h-4 bg-green-500 border-2 border-white rounded-full"></div>
                </div>
                
                <!-- Shop Info -->
                <div class="pt-12 text-center">
                    <h1 id="shop-name" class="text-2xl font-bold text-gray-900 mb-2">Loading...</h1>
                    <p id="shop-description" class="text-gray-600 text-sm mb-4 max-w-md mx-auto">Loading...</p>
                    
                    <!-- Stats -->
                    <div class="flex justify-center space-x-8 mb-6">
                        <div class="text-center">
                            <div id="follower-count" class="text-lg font-bold text-gray-900">0</div>
                            <div class="text-sm text-gray-500">Followers</div>
                        </div>
                        <div class="text-center">
                            <div id="product-count" class="text-lg font-bold text-gray-900">0</div>
                            <div class="text-sm text-gray-500">Products</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div class="px-4 pb-20">
            <h2 class="text-lg font-bold text-gray-900 mb-4">Products</h2>
            <div id="products-container" class="grid grid-cols-2 gap-3 sm:grid-cols-3 lg:grid-cols-4">
                <!-- Products will be loaded here -->
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" class="hidden text-center py-12">
                <div class="w-24 h-24 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-12 h-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">No Products Available</h3>
                <p class="text-gray-600">This shop hasn't added any products yet.</p>
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="w-24 h-24 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-12 h-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Invalid Link</h2>
            <p class="text-gray-600 mb-4">The link you're trying to access is invalid or has expired.</p>
            <div id="error-details" class="text-left bg-red-50 p-4 rounded-lg text-sm text-red-700 mb-4"></div>
            <button onclick="window.location.href='https://www.knoc.in'" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors">
                Go Home
            </button>
        </div>
    </div>

    <script>
        let shopData = null;
        let debugInfo = {
            urlParams: {},
            apiUrl: '',
            apiResponse: null,
            errors: []
        };

        // Debug panel functions
        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            panel.classList.toggle('hidden');
            updateDebugPanel();
        }

        function updateDebugPanel() {
            // Update URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const paramsHtml = Object.fromEntries(urlParams.entries());
            document.getElementById('debug-params').innerHTML = `
                <div>data: ${paramsHtml.data ? '‚úì Present' : '‚úó Missing'}</div>
                <div>sig: ${paramsHtml.sig ? '‚úì Present' : '‚úó Missing'}</div>
                <div>type: ${paramsHtml.type || 'Not set'}</div>
                <div>Full URL: ${window.location.href}</div>
            `;
            
            // Update API info
            document.getElementById('debug-api').innerHTML = `
                <div>API URL: ${debugInfo.apiUrl}</div>
                <div>Request Status: ${debugInfo.apiResponse ? 'Completed' : 'Pending'}</div>
            `;
            
            // Update response info
            if (debugInfo.apiResponse) {
                document.getElementById('debug-response').innerHTML = `
                    <div class="debug-success">‚úì Response received</div>
                    <div>Shop ID: ${debugInfo.apiResponse.shop?.id || 'Not found'}</div>
                    <div>Shop Name: ${debugInfo.apiResponse.shop?.name || 'Not found'}</div>
                    <div>Products: ${debugInfo.apiResponse.products?.length || 0}</div>
                    <div>Link Type: ${debugInfo.apiResponse.meta?.linkType || 'Unknown'}</div>
                    <div>Verified: ${debugInfo.apiResponse.meta?.verified ? 'Yes' : 'No'}</div>
                `;
            } else {
                document.getElementById('debug-response').innerHTML = '<div class="debug-warning">No response yet</div>';
            }
            
            // Update errors
            if (debugInfo.errors.length > 0) {
                document.getElementById('debug-errors').innerHTML = debugInfo.errors.map(error => 
                    `<div class="debug-error">‚Ä¢ ${error}</div>`
                ).join('');
            } else {
                document.getElementById('debug-errors').innerHTML = '<div class="debug-success">No errors</div>';
            }
        }

        // Enhanced load function with debug logging
        async function loadShopData() {
            console.log('üöÄ Starting loadShopData...');
            
            const urlParams = new URLSearchParams(window.location.search);
            debugInfo.urlParams = Object.fromEntries(urlParams.entries());
            
            console.log('üìã URL Parameters:', debugInfo.urlParams);
            console.log('üìã Raw URL:', window.location.href);
            console.log('üìã Search string:', window.location.search);
            
            try {
                let apiUrl;
                
                // Check for hashed link (data + sig parameters)
                let data = urlParams.get('data');
                let sig = urlParams.get('sig');
                const type = urlParams.get('type');
                
                // ‚úÖ FIX: Handle URL decoding issues
                if (!data || !sig) {
                    console.log('‚ö†Ô∏è Parameters missing, trying manual parsing...');
                    
                    // Try manual parsing from URL
                    const searchParams = window.location.search;
                    const dataMatch = searchParams.match(/[?&]data=([^&]+)/);
                    const sigMatch = searchParams.match(/[?&]sig=([^&]+)/);
                    
                    if (dataMatch) {
                        data = decodeURIComponent(dataMatch[1]);
                        console.log('üìã Manual data parse:', data);
                    }
                    if (sigMatch) {
                        sig = decodeURIComponent(sigMatch[1]);
                        console.log('üìã Manual sig parse:', sig);
                    }
                }
                
                console.log('üìã Final parameters:');
                console.log('- Data:', data);
                console.log('- Sig:', sig);
                console.log('- Type:', type);
                
                if (data && sig) {
                    // Hashed link
                    console.log('üîó Detected hashed link');
                    console.log('- Data:', data);
                    console.log('- Signature:', sig);
                    console.log('- Type:', type);
                    
                    apiUrl = `https://rtwtkapynafirwixyeal.supabase.co/functions/v1/web-shopView?data=${encodeURIComponent(data)}&sig=${encodeURIComponent(sig)}`;
                    if (type) {
                        apiUrl += `&type=${encodeURIComponent(type)}`;
                    }
                } else {
                    // Direct shop ID fallback
                    console.log('üîó Detected direct link');
                    const shopId = getShopIdFromUrl();
                    if (!shopId) {
                        console.error('‚ùå No shop ID found');
                        debugInfo.errors.push('No shop ID found in URL');
                        showError('No shop ID found in URL');
                        return;
                    }
                    console.log('- Shop ID:', shopId);
                    apiUrl = `https://rtwtkapynafirwixyeal.supabase.co/functions/v1/web-shopView/${shopId}`;
                }
                
                debugInfo.apiUrl = apiUrl;
                console.log('üåê API URL:', apiUrl);
                
                // Make API request
                console.log('üì° Making API request...');
                const response = await fetch(apiUrl);
                console.log('üì° Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API error:', errorText);
                    debugInfo.errors.push(`API error: ${response.status} - ${errorText}`);
                    
                    // Try to parse error as JSON for better display
                    try {
                        const errorData = JSON.parse(errorText);
                        showError(errorData.error || 'API request failed', errorData);
                    } catch (e) {
                        showError(`API request failed: ${response.status}`, { details: errorText });
                    }
                    return;
                }

                shopData = await response.json();
                debugInfo.apiResponse = shopData;
                console.log('‚úÖ Shop data loaded:', shopData);
                
                if (shopData.error) {
                    console.error('‚ùå API returned error:', shopData.error);
                    debugInfo.errors.push(`API error: ${shopData.error}`);
                    showError(shopData.error, shopData.debug);
                    return;
                }
                
                renderShopProfile();
                hideLoading();
                
            } catch (error) {
                console.error('üí• Error loading shop data:', error);
                debugInfo.errors.push(`JavaScript error: ${error.message}`);
                showError(`Network error: ${error.message}`);
            }
        }

        // Simple shop ID extraction for direct links
        function getShopIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check for direct shop parameter
            const shopFromUrl = urlParams.get('shop');
            if (shopFromUrl) return shopFromUrl;
            
            // Check URL path
            const path = window.location.pathname;
            const parts = path.split('/');
            const shopFromPath = parts[parts.length - 1];
            if (shopFromPath && shopFromPath !== 'shopProfile.html') {
                return shopFromPath;
            }
            
            return null;
        }

        // Render shop profile
        function renderShopProfile() {
            console.log('üé® Rendering shop profile...');
            
            if (!shopData || !shopData.shop) {
                console.error('‚ùå No shop data to render');
                debugInfo.errors.push('No shop data received');
                showError('No shop data received');
                return;
            }
            
            const { shop, products, stats } = shopData;
            
            console.log('- Shop:', shop.name);
            console.log('- Products:', products?.length || 0);
            
            // Update page title and meta
            document.title = `${shop.name} - Knoc`;
            const metaDesc = document.querySelector('meta[name="description"]');
            if (metaDesc) {
                metaDesc.content = `Shop ${shop.name} on Knoc. ${shop.description}`;
            }

            // Set images
            if (shop.coverImage) {
                const coverImg = document.getElementById('cover-image');
                coverImg.src = shop.coverImage;
                coverImg.classList.remove('hidden');
            }

            const profileImg = document.getElementById('profile-image');
            profileImg.src = shop.profileImage || '/default-shop-avatar.png';
            profileImg.onerror = function() {
                this.src = 'https://via.placeholder.com/80x80/ef4444/ffffff?text=' + (shop.name ? shop.name.charAt(0) : 'S');
            };

            // Update shop info
            document.getElementById('shop-name').textContent = shop.name || 'Unknown Shop';
            document.getElementById('shop-description').textContent = shop.description || 'No description available';
            document.getElementById('follower-count').textContent = formatNumber(shop.followerCount || 0);
            document.getElementById('product-count').textContent = formatNumber(stats?.totalProducts || 0);

            // Render products
            renderProducts(products || []);
            
            console.log('‚úÖ Shop profile rendered successfully');
        }

        // Render products
        function renderProducts(products) {
            console.log('üì¶ Rendering products...', products.length);
            
            const container = document.getElementById('products-container');
            const emptyState = document.getElementById('empty-state');
            
            if (products.length === 0) {
                console.log('üì¶ No products to display');
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            container.innerHTML = products.map(product => createProductCard(product)).join('');
            
            console.log('‚úÖ Products rendered successfully');
        }

        // Create product card
        function createProductCard(product) {
            const { metadata = {} } = product;
            const media = product.media && product.media[0];
            const imageUrl = media ? (media.thumbnailUrl || media.url) : null;
            
            const originalPrice = metadata.original_price || metadata.price || 299;
            const discountedPrice = metadata.discounted_price;
            const displayPrice = discountedPrice || originalPrice;
            const hasDiscount = discountedPrice && discountedPrice < originalPrice;
            const discountPercent = hasDiscount ? Math.round(((originalPrice - discountedPrice) / originalPrice) * 100) : 0;

            return `
                <div class="product-card bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="relative aspect-square">
                        ${imageUrl ? `
                            <img src="${imageUrl}" 
                                 alt="${product.content}" 
                                 class="w-full h-full object-cover"
                                 loading="lazy"
                                 onerror="this.src='https://via.placeholder.com/300x300/f3f4f6/6b7280?text=No+Image';">
                        ` : `
                            <div class="w-full h-full bg-gray-100 flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 18m-2-5V9a2 2 0 00-2-2H8a2 2 0 00-2 2v.01"></path>
                                </svg>
                            </div>
                        `}
                        
                        ${hasDiscount ? `
                            <div class="absolute top-2 left-2 bg-red-500 text-white text-xs px-2 py-1 rounded-lg font-bold">
                                ${discountPercent}% OFF
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="p-3">
                        <h3 class="font-medium text-gray-900 text-sm mb-2 line-clamp-2">${product.content || 'Untitled Product'}</h3>
                        
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col">
                                <span class="text-red-600 font-bold text-lg">‚Çπ${Math.round(displayPrice)}</span>
                                ${hasDiscount ? `
                                    <span class="text-gray-400 text-sm line-through">‚Çπ${Math.round(originalPrice)}</span>
                                ` : ''}
                            </div>
                            <button class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m6-5v6a2 2 0 11-4 0v-6m4 0V9a2 2 0 10-4 0v4.01"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Utility functions
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
        }

        function showError(message, details = null) {
            console.error('‚ùå Showing error:', message, details);
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            
            // Update error details
            const errorDetailsEl = document.getElementById('error-details');
            if (details) {
                errorDetailsEl.innerHTML = `
                    <div class="font-bold mb-2">Error Details:</div>
                    <div class="space-y-1">
                        ${typeof details === 'string' ? details : JSON.stringify(details, null, 2)}
                    </div>
                `;
                errorDetailsEl.classList.remove('hidden');
            } else {
                errorDetailsEl.classList.add('hidden');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üåü DOM Content Loaded - Starting app...');
            console.log('üåê Current URL:', window.location.href);
            
            // Show debug panel by default for testing
            const debugPanel = document.getElementById('debug-panel');
            debugPanel.classList.remove('hidden');
            
            loadShopData();
        });

        // Update debug panel every 2 seconds
        setInterval(updateDebugPanel, 2000);
    </script>
</body>
</html>
