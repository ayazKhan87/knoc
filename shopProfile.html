<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Profile - Knoc</title>
    <meta name="description" content="Shop profile and products on Knoc">
    
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://rtwtkapynafirwixyeal.supabase.co">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Enhanced CSS for Virtual Scrolling and Performance -->
    <style>
        /* Performance Optimized Base Styles */
        * {
            box-sizing: border-box;
        }
        
        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        /* Critical rendering optimization */
        .critical-render {
            contain: layout style paint;
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        /* Virtual Scrolling Container Styles */
        .virtual-scroll-container {
            position: relative;
            overflow: auto;
            height: 100%;
            contain: layout style paint;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: auto; /* Disable smooth scroll for virtual scrolling */
            transform: translateZ(0); /* Force GPU acceleration */
        }

        .virtual-scroll-content {
            position: relative;
            overflow: hidden;
            will-change: height;
        }

        .virtual-item {
            position: absolute;
            left: 0;
            right: 0;
            contain: layout style paint;
            will-change: transform, opacity;
            transition: opacity 0.2s ease;
        }

        /* Optimized Product Card Styles */
        .product-card {
            transform: translateZ(0);
            backface-visibility: hidden;
            transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
            contain: layout style paint;
            border-radius: 12px;
            overflow: hidden;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .product-card:hover {
            transform: translateY(-2px) translateZ(0);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .product-card.loading {
            opacity: 0.7;
        }

        /* Enhanced Image Loading System */
        .image-container {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            contain: layout style paint;
            aspect-ratio: 1;
        }

        .image-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
            z-index: 1;
        }

        .lazy-image {
            opacity: 0;
            transition: opacity 0.4s ease, filter 0.3s ease;
            will-change: opacity, filter;
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            inset: 0;
            z-index: 2;
        }

        .lazy-image.loading {
            opacity: 0.3;
            filter: blur(1px);
        }

        .lazy-image.loaded {
            opacity: 1;
            filter: none;
        }

        .lazy-image.error {
            opacity: 0.8;
            filter: grayscale(1);
        }

        .lazy-image.critical {
            opacity: 1 !important;
            filter: none !important;
            transition: none !important;
        }

        /* Advanced Skeleton Loading */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
            border-radius: 4px;
        }

        /* Performance Optimized Animations */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff40;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            will-change: transform;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Performance Monitor Styles */
        .performance-monitor {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            z-index: 10000;
            display: none;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(0, 255, 0, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            min-width: 200px;
        }

        .performance-monitor.show {
            display: block;
            animation: slideInLeft 0.3s ease-out;
        }

        .performance-monitor .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            padding: 2px 0;
        }

        .performance-monitor .metric:last-child {
            margin-bottom: 0;
        }

        .performance-monitor .metric-label {
            color: #888;
        }

        .performance-monitor .metric-value {
            color: #00ff00;
            font-weight: bold;
        }

        /* Memory Efficient Fade Animations */
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-up {
            animation: slideUp 0.3s ease-out forwards;
        }

        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Toast Notification System */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 350px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-content {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #10b981;
        }

        .toast-content.error {
            border-left-color: #ef4444;
        }

        .toast-content.warning {
            border-left-color: #f59e0b;
        }

        .toast-content.info {
            border-left-color: #3b82f6;
        }

        /* Enhanced Modal Styles */
        .modal-overlay {
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.6);
            transition: all 0.3s ease;
        }

        .modal-content {
            animation: modalSlide 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        @keyframes modalSlide {
            from { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        /* Floating Cart Optimization */
        .floating-cart {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));
        }

        .floating-cart:hover {
            transform: scale(1.05) translateZ(0);
        }

        .floating-cart.pulse {
            animation: cartPulse 0.6s ease-in-out;
        }

        @keyframes cartPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
            animation: countPop 0.3s ease-out;
        }

        @keyframes countPop {
            0% { transform: scale(0.5); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Debug Information Styles */
        .debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ffff;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            z-index: 10000;
            display: none;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(0, 255, 255, 0.3);
            min-width: 180px;
        }

        .debug-info.show {
            display: block;
            animation: slideInLeft 0.3s ease-out;
        }

        .debug-info .debug-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        /* Category Chips Enhanced */
        .category-chip {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            border-radius: 25px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
        }

        .category-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .category-chip.active {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        /* Responsive Optimizations */
        @media (max-width: 768px) {
            .virtual-scroll-container {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: auto;
            }
            
            .product-card {
                transition: none;
            }
            
            .product-card:hover {
                transform: none;
            }
            
            .performance-monitor {
                font-size: 10px;
                padding: 8px 12px;
                top: 5px;
                left: 5px;
            }
            
            .debug-info {
                font-size: 10px;
                padding: 8px 12px;
                bottom: 5px;
                left: 5px;
            }
            
            .toast {
                top: 10px;
                right: 10px;
                left: 10px;
                transform: translateY(-100px);
                max-width: none;
            }
            
            .toast.show {
                transform: translateY(0);
            }
        }

        @media (max-width: 640px) {
            .virtual-item {
                padding: 0 4px;
            }
        }

        /* Reduce motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
            
            .virtual-scroll-container {
                scroll-behavior: auto;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .product-card {
                border: 2px solid currentColor;
            }
            
            .performance-monitor {
                border: 2px solid currentColor;
                background: black;
            }
        }

        /* Print styles */
        @media print {
            .performance-monitor,
            .debug-info,
            .floating-cart,
            .toast {
                display: none !important;
            }
        }

        /* Connection status indicator */
        .connection-status {
            position: fixed;
            bottom: 80px;
            left: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }

        .connection-status.offline {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            opacity: 1;
            transform: translateY(0);
        }

        .connection-status.slow {
            background: rgba(245, 158, 11, 0.9);
            color: white;
            opacity: 1;
            transform: translateY(0);
        }

        /* Enhanced loading states */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            text-align: center;
            padding: 2rem;
        }

        .loading-dots {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }

        .loading-dots div {
            position: absolute;
            top: 33px;
            width: 13px;
            height: 13px;
            border-radius: 50%;
            background: #ef4444;
            animation-timing-function: cubic-bezier(0, 1, 1, 0);
        }

        .loading-dots div:nth-child(1) {
            left: 8px;
            animation: loading-dots1 0.6s infinite;
        }

        .loading-dots div:nth-child(2) {
            left: 8px;
            animation: loading-dots2 0.6s infinite;
        }

        .loading-dots div:nth-child(3) {
            left: 32px;
            animation: loading-dots2 0.6s infinite;
        }

        .loading-dots div:nth-child(4) {
            left: 56px;
            animation: loading-dots3 0.6s infinite;
        }

        @keyframes loading-dots1 {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }

        @keyframes loading-dots3 {
            0% { transform: scale(1); }
            100% { transform: scale(0); }
        }

        @keyframes loading-dots2 {
            0% { transform: translate(0, 0); }
            100% { transform: translate(24px, 0); }
        }

        /* Grid layout optimization */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            padding: 0 4px;
        }

        @media (min-width: 640px) {
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 16px;
            }
        }

        @media (min-width: 1024px) {
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 20px;
            }
        }

        /* Utility classes for performance */
        .gpu-accelerated {
            transform: translateZ(0);
            backface-visibility: hidden;
            perspective: 1000px;
        }

        .will-change-transform {
            will-change: transform;
        }

        .will-change-opacity {
            will-change: opacity;
        }

        .contain-layout {
            contain: layout;
        }

        .contain-paint {
            contain: paint;
        }

        .contain-strict {
            contain: layout style paint;
        }

        /* Enhanced scroll indicators */
        .scroll-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, #ef4444, #dc2626);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.1s ease;
            z-index: 9999;
        }

        /* Focus indicators for accessibility */
        .focus-visible:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        /* Enhanced button styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            text-decoration: none;
            user-select: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        /* Error boundary styles */
        .error-boundary {
            padding: 2rem;
            text-align: center;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            margin: 1rem;
        }

        .error-boundary h2 {
            color: #dc2626;
            margin-bottom: 1rem;
        }

        .error-boundary p {
            color: #6b7280;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Scroll Progress Indicator -->
    <div id="scroll-indicator" class="scroll-indicator"></div>

    <!-- Performance Monitor (Debug Mode) -->
    <div id="performance-monitor" class="performance-monitor">
        <div class="metric">
            <span class="metric-label">DOM Nodes:</span>
            <span class="metric-value" id="dom-count">0</span>
        </div>
        <div class="metric">
            <span class="metric-label">Memory:</span>
            <span class="metric-value" id="memory-usage">0 MB</span>
        </div>
        <div class="metric">
            <span class="metric-label">FPS:</span>
            <span class="metric-value" id="fps-counter">60</span>
        </div>
        <div class="metric">
            <span class="metric-label">Images:</span>
            <span class="metric-value" id="image-stats">0/0</span>
        </div>
        <div class="metric">
            <span class="metric-label">Network:</span>
            <span class="metric-value" id="network-status">Unknown</span>
        </div>
    </div>

    <!-- Debug Information -->
    <div id="debug-info" class="debug-info">
        <div class="debug-metric">
            <span>Rendered:</span>
            <span id="rendered-count">0</span>
        </div>
        <div class="debug-metric">
            <span>Range:</span>
            <span id="visible-range">0-0</span>
        </div>
        <div class="debug-metric">
            <span>Pool:</span>
            <span id="pool-size">0</span>
        </div>
        <div class="debug-metric">
            <span>Recycled:</span>
            <span id="recycled-count">0</span>
        </div>
        <div class="debug-metric">
            <span>Total:</span>
            <span id="total-items">0</span>
        </div>
    </div>

    <!-- Connection Status -->
    <div id="connection-status" class="connection-status">
        <span id="connection-text">Connection lost</span>
    </div>

    <!-- Loading State -->
    <div id="loading" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-dots">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>
            <p class="mt-4 text-lg font-semibold text-gray-700">Loading shop data...</p>
            <p class="text-sm text-gray-500 mt-2">Optimizing for best performance...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast hidden">
        <div class="toast-content" id="toast-content">
            <div class="flex items-start">
                <div id="toast-icon" class="flex-shrink-0 w-6 h-6 mr-3 mt-0.5"></div>
                <div class="flex-1">
                    <p id="toast-title" class="text-sm font-semibold text-gray-900"></p>
                    <p id="toast-message" class="text-sm text-gray-600 mt-1"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Cart Button -->
    <div id="floating-cart" class="floating-cart hidden">
        <button onclick="openOrderModal()" class="btn btn-primary rounded-full p-4 text-white shadow-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m6-5v6a2 2 0 11-4 0v-6m4 0V9a2 2 0 10-4 0v4.01"></path>
            </svg>
            <span id="floating-cart-count" class="cart-count">0</span>
        </button>
    </div>

    <!-- Main Content -->
    <div id="content" class="hidden min-h-screen">
        <!-- Header Section -->
        <div class="relative">
            <!-- Cover Image -->
            <div id="cover-section" class="h-48 bg-gradient-to-br from-red-500 via-red-600 to-red-700 relative overflow-hidden">
                <div class="image-container w-full h-full">
                    <div class="image-placeholder">
                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 18m-2-5V9a2 2 0 00-2-2H8a2 2 0 00-2 2v.01"></path>
                        </svg>
                    </div>
                    <img id="cover-image" 
                         class="lazy-image critical w-full h-full object-cover" 
                         alt="Shop Cover"
                         loading="eager"
                         decoding="async">
                </div>
                <div class="absolute inset-0 bg-gradient-to-b from-black/20 via-transparent to-black/40"></div>
                
                <!-- Back Button -->
                <button onclick="history.back()" 
                        class="absolute top-4 left-4 bg-black/20 hover:bg-black/40 backdrop-blur-sm rounded-full p-3 transition-all z-10 focus-visible">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Profile Section -->
            <div class="relative px-4 pb-6">
                <!-- Profile Image -->
                <div class="absolute -top-12 left-1/2 transform -translate-x-1/2">
                    <div class="w-24 h-24 rounded-full border-4 border-white bg-gray-200 overflow-hidden shadow-xl">
                        <div class="image-container w-full h-full rounded-full">
                            <div class="image-placeholder">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <img id="profile-image" 
                                 class="lazy-image critical w-full h-full object-cover rounded-full" 
                                 alt="Shop Logo"
                                 loading="eager"
                                 decoding="async">
                        </div>
                    </div>
                    <div class="absolute bottom-1 right-1 w-5 h-5 bg-green-500 border-2 border-white rounded-full animate-pulse"></div>
                </div>
                
                <!-- Shop Info -->
                <div class="pt-16 text-center">
                    <div class="flex items-center justify-center space-x-3 mb-3">
                        <div class="flex items-center text-yellow-500 bg-yellow-50 px-3 py-1 rounded-full">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                            </svg>
                            <span id="shop-rating" class="ml-1 font-semibold text-sm">4.9</span>
                        </div>
                        <span id="verified-badge" class="hidden bg-blue-100 text-blue-600 text-xs px-3 py-1 rounded-full font-medium">
                            <svg class="w-3 h-3 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            Verified
                        </span>
                    </div>
                    
                    <h1 id="shop-name" class="text-3xl font-bold text-gray-900 mb-3">Shop Name</h1>
                    <p id="shop-description" class="text-gray-600 text-base mb-6 max-w-md mx-auto leading-relaxed">Shop description goes here...</p>
                    
                    <!-- Stats -->
                    <div class="flex justify-center space-x-12 mb-8">
                        <div class="text-center">
                            <div id="follower-count" class="text-2xl font-bold text-gray-900">0</div>
                            <div class="text-sm text-gray-500 font-medium">Followers</div>
                        </div>
                        <div class="text-center">
                            <div id="product-count" class="text-2xl font-bold text-gray-900">0</div>
                            <div class="text-sm text-gray-500 font-medium">Products</div>
                        </div>
                        <div class="text-center">
                            <div id="orders-count" class="text-2xl font-bold text-gray-900">0</div>
                            <div class="text-sm text-gray-500 font-medium">Orders</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-3 justify-center mb-8">
                        <button onclick="downloadApp()" class="btn btn-primary px-6 py-3 text-sm font-semibold">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                            Download App
                        </button>
                        <button id="share-btn" class="btn btn-secondary px-6 py-3 text-sm font-semibold">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                            </svg>
                            Share
                        </button>
                        <button onclick="toggleDebugMode()" class="btn btn-secondary px-4 py-3 text-sm font-semibold">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            Debug
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Promotion Banner -->
        <div id="promotion-banner" class="hidden mx-4 mb-6 p-4 bg-gradient-to-r from-orange-400 via-red-500 to-red-600 rounded-2xl text-white shadow-lg overflow-hidden relative">
            <div class="absolute inset-0 bg-black/10"></div>
            <div class="relative flex items-center justify-between">
                <div class="flex-1">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 mr-2 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-sm font-bold tracking-wider">SPECIAL OFFER</span>
                    </div>
                    <h3 id="promotion-title" class="text-lg font-bold mb-1">Limited Time Deal</h3>
                    <p id="promotion-description" class="text-sm opacity-90"></p>
                </div>
                <div class="text-center ml-4">
                    <div id="promotion-percent" class="text-3xl font-bold">20%</div>
                    <div class="text-sm font-bold">OFF</div>
                </div>
            </div>
        </div>

        <!-- AI Disclaimer Banner -->
        <div class="mx-4 mb-6 p-4 bg-blue-50 border border-blue-200 rounded-xl shadow-sm">
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 mt-1">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="text-sm">
                    <p class="text-blue-800 font-semibold mb-2">
                        üì∏ <strong>Image Disclaimer</strong>
                    </p>
                    <p class="text-blue-700 mb-2">
                        <strong>English:</strong> The product images shown may be AI-generated for visual representation. Actual dishes may look different from the images displayed.
                    </p>
                    <p class="text-blue-700">
                        <strong>‡§π‡§ø‡§Ç‡§¶‡•Ä:</strong> ‡§¶‡§ø‡§ñ‡§æ‡§è ‡§ó‡§è ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§ö‡§ø‡§§‡•ç‡§∞ ‡§¶‡•É‡§∂‡•ç‡§Ø ‡§™‡•ç‡§∞‡§§‡§ø‡§®‡§ø‡§ß‡§ø‡§§‡•ç‡§µ ‡§ï‡•á ‡§≤‡§ø‡§è AI-‡§ú‡§®‡§∞‡•á‡§ü‡•á‡§° ‡§π‡•ã ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§µ‡•ç‡§Ø‡§Ç‡§ú‡§® ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§ø‡§§ ‡§õ‡§µ‡§ø‡§Ø‡•ã‡§Ç ‡§∏‡•á ‡§Ö‡§≤‡§ó ‡§¶‡§ø‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§
                    </p>
                </div>
            </div>
        </div>

        <!-- Products Section Header -->
        <div class="px-4 mb-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-1">Products</h2>
                    <p class="text-sm text-gray-600" id="products-subtitle">Discover our amazing collection</p>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- Performance Indicator -->
                    <div id="performance-indicator" class="hidden bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-medium">
                        <svg class="w-3 h-3 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        Optimized
                    </div>
                    
                    <!-- View Mode Selector -->
                    <select id="view-mode" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        <option value="virtual">üöÄ Virtual (Recommended)</option>
                        <option value="traditional">üìã Traditional</option>
                        <option value="hybrid">‚ö° Hybrid</option>
                    </select>
                </div>
            </div>
            
            <!-- Categories Filter -->
            <div class="mb-4">
                <h3 class="text-sm font-semibold text-gray-700 mb-3">Categories</h3>
                <div id="categories-container" class="flex space-x-2 overflow-x-auto pb-2 scrollbar-hide">
                    <button class="category-chip active" data-category="all">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14-7H5m14 14H5"></path>
                        </svg>
                        All Products
                    </button>
                </div>
            </div>

            <!-- Filter and Sort Controls -->
            <div class="flex items-center justify-between mb-4 p-3 bg-white rounded-lg border border-gray-200">
                <div class="flex items-center space-x-4">
                    <button id="filter-btn" class="flex items-center text-sm text-gray-600 hover:text-gray-900">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.414A1 1 0 013 6.707V4z"></path>
                        </svg>
                        Filter
                    </button>
                    <select id="sort-select" class="text-sm border-0 bg-transparent focus:outline-none text-gray-600">
                        <option value="default">Default Order</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="name">Name A-Z</option>
                        <option value="popularity">Most Popular</option>
                    </select>
                </div>
                <div class="text-sm text-gray-500">
                    <span id="showing-count">Showing 0</span> of <span id="total-count">0</span> products
                </div>
            </div>
        </div>

        <!-- Virtual Scrolling Products Container -->
        <div class="px-4 pb-20">
            <!-- Virtual Scroll Container -->
            <div id="virtual-container" class="virtual-scroll-container relative" style="height: 80vh;">
                <div id="virtual-content" class="virtual-scroll-content">
                    <!-- Virtual items will be rendered here -->
                </div>
                
                <!-- Loading indicator for virtual scroll -->
                <div id="virtual-loading" class="hidden absolute inset-0 flex items-center justify-center">
                    <div class="text-center">
                        <div class="loading-spinner mx-auto mb-2"></div>
                        <p class="text-sm text-gray-600">Loading products...</p>
                    </div>
                </div>
            </div>
            
            <!-- Traditional Container (fallback) -->
            <div id="traditional-container" class="hidden">
                <div class="product-grid">
                    <!-- Traditional items will be rendered here -->
                </div>
            </div>
            
            <!-- Hybrid Container -->
            <div id="hybrid-container" class="hidden">
                <!-- First few items load immediately -->
                <div id="immediate-products" class="product-grid mb-6">
                    <!-- Critical above-fold products -->
                </div>
                
                <!-- Virtual scroll for remaining items -->
                <div class="virtual-scroll-container" style="height: 60vh;">
                    <div id="hybrid-virtual-content" class="virtual-scroll-content">
                        <!-- Virtual items for below-fold content -->
                    </div>
                </div>
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" class="hidden text-center py-16">
                <div class="w-32 h-32 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-16 h-16 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-3">No Products Available</h3>
                <p class="text-gray-600 mb-6">This shop hasn't added any products yet.</p>
                <button onclick="window.location.reload()" class="btn btn-primary px-6 py-3">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh Page
                </button>
            </div>

            <!-- Load More Button (for traditional mode) -->
            <div id="load-more-container" class="hidden text-center mt-8">
                <button id="load-more-btn" onclick="loadMoreProducts()" class="btn btn-secondary px-8 py-3">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Load More Products
                </button>
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="text-center max-w-md">
            <div class="w-32 h-32 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-16 h-16 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-3">Something went wrong</h2>
            <p class="text-gray-600 mb-6">The link you're trying to access is invalid or has expired.</p>
            <div class="space-y-3">
                <button onclick="window.location.reload()" class="btn btn-primary px-6 py-3 w-full">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Try Again
                </button>
                <button onclick="window.location.href='https://www.knoc.in'" class="btn btn-secondary px-6 py-3 w-full">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    Go Home
                </button>
            </div>
        </div>
    </div>

    <!-- Order List Modal -->
    <div id="order-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 modal-overlay transition-opacity" onclick="closeOrderModal()"></div>
            
            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full modal-content">
                <div class="bg-white px-6 pt-6 pb-4">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">Your Order</h3>
                            <p class="text-sm text-gray-600 mt-1">Review your items before proceeding</p>
                        </div>
                        <button onclick="closeOrderModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div id="order-list" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                        <!-- Order items will be shown here -->
                    </div>
                    
                    <div id="order-empty" class="hidden text-center py-12">
                        <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m6-5v6a2 2 0 11-4 0v-6m4 0V9a2 2 0 10-4 0v4.01"></path>
                            </svg>
                        </div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">Your cart is empty</h4>
                        <p class="text-gray-600">Add some delicious items to get started!</p>
                    </div>
                </div>
                
                <div id="order-footer" class="hidden bg-gray-50 px-6 py-4">
                    <div class="w-full">
                        <div class="flex justify-between items-center mb-4 p-3 bg-white rounded-lg border">
                            <span class="text-lg font-bold text-gray-900">Total Amount:</span>
                            <span id="order-total" class="text-xl font-bold text-red-600">‚Çπ0</span>
                        </div>
                        <button onclick="proceedToOrder()" class="w-full btn btn-primary py-3 text-base font-semibold">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                            </svg>
                            Proceed to Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Type Modal -->
    <div id="order-type-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 modal-overlay transition-opacity" onclick="closeOrderTypeModal()"></div>
            
            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full modal-content">
                <div class="bg-white px-6 pt-6 pb-4">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">Order Type</h3>
                            <p class="text-sm text-gray-600 mt-1">How would you like to receive your order?</p>
                        </div>
                        <button onclick="closeOrderTypeModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <button onclick="selectOrderType('dine_in')" class="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-red-500 hover:bg-red-50 transition-all text-left group">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4 group-hover:bg-red-200 transition-colors">
                                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2v0"></path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900 mb-1">Dine In</h4>
                                    <p class="text-sm text-gray-600">Eat at the restaurant</p>
                                </div>
                                <div class="ml-auto">
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-red-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="selectOrderType('delivery')" class="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-red-500 hover:bg-red-50 transition-all text-left group">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4 group-hover:bg-red-200 transition-colors">
                                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900 mb-1">Delivery</h4>
                                    <p class="text-sm text-gray-600">Get it delivered to your location</p>
                                </div>
                                <div class="ml-auto">
                                    <svg class="w-5 h-5 text-gray-400 group-hover:text-red-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table Number Modal -->
    <div id="table-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 modal-overlay transition-opacity" onclick="closeTableModal()"></div>
            
            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full modal-content">
                <div class="bg-white px-6 pt-6 pb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">Table Information</h3>
                            <p class="text-sm text-gray-600 mt-1">Please provide your table number</p>
                        </div>
                        <button onclick="closeTableModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="table-number" class="block text-sm font-medium text-gray-700 mb-2">Table Number *</label>
                            <input type="text" 
                                   id="table-number" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors" 
                                   placeholder="e.g., 5, A3, Table 12"
                                   required>
                        </div>
                        
                        <div>
                            <label for="order-notes" class="block text-sm font-medium text-gray-700 mb-2">Special Instructions (Optional)</label>
                            <textarea id="order-notes" 
                                      rows="3" 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors resize-none" 
                                      placeholder="Any special requests or dietary requirements..."></textarea>
                        </div>
                        
                        <button id="confirm-dine-btn" onclick="confirmDineInOrder()" class="w-full btn btn-primary py-3 text-base font-semibold mt-6">
                            <span class="btn-text flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Confirm Dine-In Order
                            </span>
                            <div class="loading-spinner hidden mx-auto"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Address Modal -->
    <div id="address-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 modal-overlay transition-opacity" onclick="closeAddressModal()"></div>
            
            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full modal-content">
                <div class="bg-white px-6 pt-6 pb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">Delivery Information</h3>
                            <p class="text-sm text-gray-600 mt-1">Where should we deliver your order?</p>
                        </div>
                        <button onclick="closeAddressModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="delivery-address" class="block text-sm font-medium text-gray-700 mb-2">Delivery Address *</label>
                            <textarea id="delivery-address" 
                                      rows="3" 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors resize-none" 
                                      placeholder="Enter complete delivery address including landmarks..."
                                      required></textarea>
                        </div>
                        
                        <div>
                            <label for="customer-phone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                            <input type="tel" 
                                   id="customer-phone" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors" 
                                   placeholder="+91 9876543210"
                                   required>
                        </div>
                        
                        <div>
                            <label for="delivery-notes" class="block text-sm font-medium text-gray-700 mb-2">Special Instructions (Optional)</label>
                            <textarea id="delivery-notes" 
                                      rows="2" 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors resize-none" 
                                      placeholder="Any special requests, dietary requirements, or delivery instructions..."></textarea>
                        </div>
                        
                        <button id="confirm-delivery-btn" onclick="confirmDeliveryOrder()" class="w-full btn btn-primary py-3 text-base font-semibold mt-6">
                            <span class="btn-text flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.515"/>
                                </svg>
                                Order via WhatsApp
                            </span>
                            <div class="loading-spinner hidden mx-auto"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====================================
        // ADVANCED VIRTUAL SCROLLING CLASS
        // ====================================
        
        class AdvancedVirtualScrollManager {
            constructor(container, options = {}) {
                this.container = container;
                this.content = container.querySelector('#virtual-content') || container.children[0];
                
                // Configuration
                this.config = {
                    itemHeight: options.itemHeight || 180,
                    tolerance: options.tolerance || 8,
                    preloadBatch: options.preloadBatch || 20,
                    maxPoolSize: options.maxPoolSize || 50,
                    debounceMs: options.debounceMs || 16,
                    ...options
                };
                
                // State management
                this.state = {
                    items: [],
                    visibleItems: new Map(),
                    nodePool: [],
                    startIndex: 0,
                    endIndex: 0,
                    isScrolling: false,
                    isDestroyed: false,
                    recycledCount: 0,
                    totalRendered: 0
                };
                
                // Performance tracking
                this.performance = {
                    scrollRAF: null,
                    resizeRAF: null,
                    lastScrollTime: 0,
                    frameCount: 0,
                    avgFrameTime: 16.67
                };
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.setupResizeObserver();
                this.setupIntersectionObserver();
                
                // Initial render
                this.calculateVisibleRange();
                this.renderVisibleItems();
            }
            
            setupEventListeners() {
                // Optimized scroll handler with passive listening
                this.boundScrollHandler = this.handleScroll.bind(this);
                this.container.addEventListener('scroll', this.boundScrollHandler, { 
                    passive: true, 
                    capture: false 
                });
                
                // Window resize handling
                this.boundResizeHandler = this.handleResize.bind(this);
                window.addEventListener('resize', this.boundResizeHandler, { passive: true });
                
                // Visibility change optimization
                this.boundVisibilityHandler = this.handleVisibilityChange.bind(this);
                document.addEventListener('visibilitychange', this.boundVisibilityHandler);
            }
            
            setupResizeObserver() {
                if ('ResizeObserver' in window) {
                    this.resizeObserver = new ResizeObserver(() => {
                        this.handleResize();
                    });
                    this.resizeObserver.observe(this.container);
                }
            }
            
            setupIntersectionObserver() {
                // For image lazy loading optimization
                this.imageObserver = new IntersectionObserver(
                    this.handleImageIntersection.bind(this),
                    {
                        root: this.container,
                        rootMargin: '100px 0px',
                        threshold: [0, 0.1, 0.5]
                    }
                );
            }
            
            setItems(items) {
                this.state.items = items;
                this.content.style.height = `${items.length * this.config.itemHeight}px`;
                this.calculateVisibleRange();
                this.renderVisibleItems();
                this.updateDebugInfo();
                this.updatePerformanceIndicator();
            }
            
            handleScroll() {
                if (this.state.isDestroyed) return;
                
                const now = performance.now();
                this.performance.lastScrollTime = now;
                
                if (this.performance.scrollRAF) {
                    cancelAnimationFrame(this.performance.scrollRAF);
                }
                
                this.performance.scrollRAF = requestAnimationFrame(() => {
                    if (this.state.isDestroyed) return;
                    
                    const frameTime = performance.now() - now;
                    this.updateFrameTime(frameTime);
                    
                    this.calculateVisibleRange();
                    this.renderVisibleItems();
                    this.updateDebugInfo();
                    this.updateScrollProgress();
                });
            }
            
            handleResize() {
                if (this.state.isDestroyed) return;
                
                if (this.performance.resizeRAF) {
                    cancelAnimationFrame(this.performance.resizeRAF);
                }
                
                this.performance.resizeRAF = requestAnimationFrame(() => {
                    this.calculateVisibleRange();
                    this.renderVisibleItems();
                });
            }
            
            handleVisibilityChange() {
                if (document.hidden) {
                    // Pause updates when tab is hidden
                    this.state.isHidden = true;
                    if (this.performance.scrollRAF) {
                        cancelAnimationFrame(this.performance.scrollRAF);
                        this.performance.scrollRAF = null;
                    }
                } else {
                    // Resume updates when tab becomes visible
                    this.state.isHidden = false;
                    this.handleScroll();
                }
            }
            
            calculateVisibleRange() {
                const scrollTop = this.container.scrollTop;
                const containerHeight = this.container.clientHeight;
                const itemHeight = this.config.itemHeight;
                const tolerance = this.config.tolerance;
                
                // Calculate visible range with smart tolerance
                const visibleStart = Math.floor(scrollTop / itemHeight);
                const visibleEnd = Math.ceil((scrollTop + containerHeight) / itemHeight);
                
                this.state.startIndex = Math.max(0, visibleStart - tolerance);
                this.state.endIndex = Math.min(
                    this.state.items.length,
                    visibleEnd + tolerance
                );
            }
            
            renderVisibleItems() {
                if (this.state.isDestroyed || this.state.isHidden) return;
                
                const itemsToRender = new Set();
                
                // Mark items that should be visible
                for (let i = this.state.startIndex; i < this.state.endIndex; i++) {
                    itemsToRender.add(i);
                }
                
                // Remove items that are no longer visible (with batching)
                const itemsToRemove = [];
                this.state.visibleItems.forEach((node, index) => {
                    if (!itemsToRender.has(index)) {
                        itemsToRemove.push(index);
                    }
                });
                
                // Batch removal for better performance
                itemsToRemove.forEach(index => {
                    this.recycleNode(index);
                });
                
                // Add new items that are now visible (with batching)
                const itemsToAdd = [];
                itemsToRender.forEach(index => {
                    if (!this.state.visibleItems.has(index)) {
                        itemsToAdd.push(index);
                    }
                });
                
                // Batch addition
                itemsToAdd.forEach(index => {
                    this.renderItem(index);
                });
                
                this.state.totalRendered = this.state.visibleItems.size;
            }
            
            renderItem(index) {
                if (index >= this.state.items.length) return;
                
                const item = this.state.items[index];
                const node = this.getOrCreateNode();
                
                // Position the node
                node.style.top = `${index * this.config.itemHeight}px`;
                node.style.height = `${this.config.itemHeight}px`;
                
                // Render content
                node.innerHTML = this.createItemHTML(item, index);
                
                // Add to DOM and track
                this.content.appendChild(node);
                this.state.visibleItems.set(index, node);
                
                // Initialize image loading
                this.initializeLazyLoading(node);
                
                // Add entrance animation
                node.classList.add('fade-in');
            }
            
            recycleNode(index) {
                const node = this.state.visibleItems.get(index);
                if (!node || !node.parentNode) return;
                
                // Clean up observers and event listeners
                this.cleanupNode(node);
                
                // Remove from DOM
                node.parentNode.removeChild(node);
                
                // Add to pool if not full
                if (this.state.nodePool.length < this.config.maxPoolSize) {
                    node.classList.remove('fade-in');
                    this.state.nodePool.push(node);
                    this.state.recycledCount++;
                }
                
                // Remove from tracking
                this.state.visibleItems.delete(index);
            }
            
            getOrCreateNode() {
                if (this.state.nodePool.length > 0) {
                    return this.state.nodePool.pop();
                }
                
                // Create new node with optimized structure
                const node = document.createElement('div');
                node.className = 'virtual-item critical-render';
                node.style.position = 'absolute';
                node.style.left = '0';
                node.style.right = '0';
                node.style.contain = 'layout style paint';
                
                return node;
            }
            
            createItemHTML(product, index) {
                const { metadata = {} } = product;
                const media = product.media && product.media.length > 0 ? product.media[0] : null;
                const imageUrl = media ? (media.thumbnailUrl || media.url) : null;
                
                const productName = metadata.product_name || product.content || '';
                const originalPrice = metadata.price;
                const discountedPrice = metadata.discounted_price;
                const displayPrice = discountedPrice || originalPrice;
                
                const isOrderable = this.canOrderProduct(product);
                const hasDiscount = discountedPrice && originalPrice && discountedPrice < originalPrice;
                const discountPercent = hasDiscount ? Math.round(((originalPrice - discountedPrice) / originalPrice) * 100) : 0;

                return `
                    <div class="product-card bg-white rounded-xl shadow-sm overflow-hidden relative h-full mx-2 my-2 critical-render">
                        <div class="image-container relative bg-gray-100">
                            ${imageUrl ? `
                                <div class="image-placeholder">
                                    <div class="skeleton w-8 h-8 rounded"></div>
                                </div>
                                <img src="" 
                                     data-src="${imageUrl}"
                                     alt="${productName}" 
                                     class="lazy-image w-full h-full object-cover"
                                     loading="lazy"
                                     decoding="async"
                                     width="300"
                                     height="300">
                            ` : `
                                <div class="w-full h-full flex items-center justify-center">
                                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 18m-2-5V9a2 2 0 00-2-2H8a2 2 0 00-2 2v.01"></path>
                                    </svg>
                                </div>
                            `}
                            ${hasDiscount ? `
                                <div class="absolute top-2 left-2 bg-gradient-to-r from-red-500 to-red-600 text-white text-xs px-2 py-1 rounded-lg font-bold shadow-sm">
                                    ${discountPercent}% OFF
                                </div>
                            ` : ''}
                            <div class="absolute top-2 right-2 w-8 h-8 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity cursor-pointer" onclick="toggleWishlist('${product.id}')">
                                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <div class="p-3">
                            <h3 class="font-medium text-gray-900 text-sm mb-2 line-clamp-2 leading-tight">${this.escapeHtml(productName) || 'Product Name Not Available'}</h3>
                            
                            <div class="flex items-center justify-between">
                                <div class="flex flex-col">
                                    ${isOrderable ? `
                                        <div class="flex items-center space-x-2">
                                            <span class="text-red-600 font-bold text-lg">‚Çπ${Math.round(displayPrice)}</span>
                                            ${hasDiscount ? `
                                                <span class="text-gray-400 text-sm line-through">‚Çπ${Math.round(originalPrice)}</span>
                                            ` : ''}
                                        </div>
                                    ` : `
                                        <span class="text-gray-400 text-sm">Price not available</span>
                                    `}
                                </div>
                                ${isOrderable ? `
                                    <button onclick="addToOrder(${this.escapeJson(product)})" 
                                            class="btn btn-primary px-3 py-1.5 text-sm font-medium rounded-lg transition-all hover:scale-105 focus:scale-95">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        Add
                                    </button>
                                ` : `
                                    <button disabled class="bg-gray-300 text-gray-500 px-3 py-1.5 rounded-lg text-sm font-medium cursor-not-allowed">
                                        Unavailable
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            initializeLazyLoading(node) {
                const images = node.querySelectorAll('.lazy-image[data-src]');
                images.forEach(img => {
                    if (this.imageObserver) {
                        this.imageObserver.observe(img);
                    }
                });
            }
            
            handleImageIntersection(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        this.loadImage(img);
                        this.imageObserver.unobserve(img);
                    }
                });
            }
            
            async loadImage(img) {
                const src = img.dataset.src;
                if (!src) return;
                
                try {
                    img.classList.add('loading');
                    
                    // Create a promise for image loading
                    await new Promise((resolve, reject) => {
                        const tempImg = new Image();
                        
                        tempImg.onload = () => {
                            img.src = src;
                            img.classList.remove('loading');
                            img.classList.add('loaded');
                            
                            // Remove placeholder
                            const placeholder = img.parentElement?.querySelector('.image-placeholder');
                            if (placeholder) {
                                placeholder.style.opacity = '0';
                                setTimeout(() => placeholder?.remove(), 300);
                            }
                            
                            resolve();
                        };
                        
                        tempImg.onerror = () => {
                            img.classList.remove('loading');
                            img.classList.add('error');
                            img.src = this.createFallbackImage();
                            reject();
                        };
                        
                        tempImg.src = src;
                    });
                    
                } catch (error) {
                    console.warn('Failed to load image:', src);
                }
            }
            
            createFallbackImage() {
                return 'data:image/svg+xml;base64,' + btoa(`
                    <svg width="200" height="200" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                        <rect width="200" height="200" fill="#f3f4f6"/>
                        <rect x="60" y="70" width="80" height="60" fill="#e5e7eb" rx="4"/>
                        <circle cx="80" cy="90" r="6" fill="#9ca3af"/>
                        <path d="M60 110l16-16 8 8 16-16 40 32v12H60z" fill="#9ca3af"/>
                        <text x="100" y="150" text-anchor="middle" fill="#6b7280" font-size="12" font-family="system-ui">
                            Image not available
                        </text>
                    </svg>
                `);
            }
            
            cleanupNode(node) {
                // Clean up image observers
                const images = node.querySelectorAll('.lazy-image');
                images.forEach(img => {
                    if (this.imageObserver) {
                        this.imageObserver.unobserve(img);
                    }
                });
                
                // Remove any event listeners that might be attached
                const buttons = node.querySelectorAll('button');
                buttons.forEach(btn => {
                    btn.onclick = null;
                });
                
                // Clear innerHTML to prevent memory leaks
                node.innerHTML = '';
            }
            
            canOrderProduct(product) {
                const { metadata = {} } = product;
                const productName = metadata.product_name || product.content;
                const price = metadata.price;
                return productName && productName.trim() !== '' && price && price > 0;
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            escapeJson(obj) {
                return JSON.stringify(obj).replace(/"/g, '&quot;');
            }
            
            updateFrameTime(frameTime) {
                this.performance.frameCount++;
                this.performance.avgFrameTime = (this.performance.avgFrameTime + frameTime) / 2;
            }
            
            updateDebugInfo() {
                if (!debugMode) return;
                
                try {
                    document.getElementById('rendered-count').textContent = this.state.visibleItems.size;
                    document.getElementById('visible-range').textContent = `${this.state.startIndex}-${this.state.endIndex}`;
                    document.getElementById('pool-size').textContent = this.state.nodePool.length;
                    document.getElementById('recycled-count').textContent = this.state.recycledCount;
                    document.getElementById('total-items').textContent = this.state.items.length;
                } catch (error) {
                    // Ignore errors if debug elements don't exist
                }
            }
            
            updateScrollProgress() {
                const scrollIndicator = document.getElementById('scroll-indicator');
                if (scrollIndicator) {
                    const scrollPercent = this.container.scrollTop / (this.container.scrollHeight - this.container.clientHeight);
                    scrollIndicator.style.transform = `scaleX(${Math.min(scrollPercent, 1)})`;
                }
            }
            
            updatePerformanceIndicator() {
                const indicator = document.getElementById('performance-indicator');
                if (indicator && this.state.items.length > 100) {
                    indicator.classList.remove('hidden');
                }
            }
            
            // Public API methods
            scrollToIndex(index) {
                if (index < 0 || index >= this.state.items.length) return;
                
                const targetScrollTop = index * this.config.itemHeight;
                this.container.scrollTo({
                    top: targetScrollTop,
                    behavior: 'smooth'
                });
            }
            
            getVisibleItems() {
                return Array.from(this.state.visibleItems.keys()).map(index => this.state.items[index]);
            }
            
            refresh() {
                this.calculateVisibleRange();
                this.renderVisibleItems();
            }
            
            destroy() {
                this.state.isDestroyed = true;
                
                // Cancel any pending animation frames
                if (this.performance.scrollRAF) {
                    cancelAnimationFrame(this.performance.scrollRAF);
                }
                if (this.performance.resizeRAF) {
                    cancelAnimationFrame(this.performance.resizeRAF);
                }
                
                // Clean up all visible items
                this.state.visibleItems.forEach((node, index) => {
                    this.cleanupNode(node);
                });
                
                // Disconnect observers
                if (this.resizeObserver) {
                    this.resizeObserver.disconnect();
                }
                if (this.imageObserver) {
                    this.imageObserver.disconnect();
                }
                
                // Remove event listeners
                this.container.removeEventListener('scroll', this.boundScrollHandler);
                window.removeEventListener('resize', this.boundResizeHandler);
                document.removeEventListener('visibilitychange', this.boundVisibilityHandler);
                
                // Clear references
                this.state.visibleItems.clear();
                this.state.nodePool = [];
                this.state.items = [];
                
                console.log('üßπ Virtual scroll manager destroyed and cleaned up');
            }
        }

        // ====================================
        // ENHANCED IMAGE LOADER CLASS
        // ====================================
        
        class EnhancedImageLoader {
            constructor() {
                this.loadedImages = new Set();
                this.failedImages = new Set();
                this.pendingImages = new Map();
                this.loadingQueue = [];
                this.maxConcurrent = 6;
                this.currentLoading = 0;
                this.connectionQuality = 'unknown';
                this.retryAttempts = new Map();
                this.maxRetries = 2;
                
                this.init();
            }
            
            init() {
                this.detectConnectionQuality();
                this.setupConnectionMonitoring();
                this.startQueueProcessor();
            }
            
            detectConnectionQuality() {
                if ('connection' in navigator) {
                    const connection = navigator.connection;
                    const effectiveType = connection.effectiveType;
                    
                    switch (effectiveType) {
                        case '4g':
                            this.connectionQuality = 'fast';
                            this.maxConcurrent = 8;
                            break;
                        case '3g':
                            this.connectionQuality = 'medium';
                            this.maxConcurrent = 4;
                            break;
                        case '2g':
                        case 'slow-2g':
                            this.connectionQuality = 'slow';
                            this.maxConcurrent = 2;
                            break;
                        default:
                            this.connectionQuality = 'medium';
                            this.maxConcurrent = 4;
                    }
                } else {
                    // Fallback: detect based on performance
                    this.measureConnectionSpeed();
                }
                
                this.updateNetworkStatus();
            }
            
            measureConnectionSpeed() {
                const start = performance.now();
                const testImage = new Image();
                
                testImage.onload = () => {
                    const loadTime = performance.now() - start;
                    if (loadTime < 500) {
                        this.connectionQuality = 'fast';
                        this.maxConcurrent = 8;
                    } else if (loadTime < 1500) {
                        this.connectionQuality = 'medium';
                        this.maxConcurrent = 4;
                    } else {
                        this.connectionQuality = 'slow';
                        this.maxConcurrent = 2;
                    }
                    this.updateNetworkStatus();
                };
                
                testImage.onerror = () => {
                    this.connectionQuality = 'slow';
                    this.maxConcurrent = 2;
                    this.updateNetworkStatus();
                };
                
                // Use a small test image
                testImage.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
            }
            
            setupConnectionMonitoring() {
                if ('connection' in navigator) {
                    navigator.connection.addEventListener('change', () => {
                        this.detectConnectionQuality();
                    });
                }
                
                window.addEventListener('online', () => {
                    this.retryFailedImages();
                    this.processQueue();
                });
                
                window.addEventListener('offline', () => {
                    this.updateNetworkStatus();
                });
            }
            
            startQueueProcessor() {
                // Process queue every 100ms
                setInterval(() => {
                    this.processQueue();
                }, 100);
            }
            
            processQueue() {
                if (!navigator.onLine) return;
                
                while (this.currentLoading < this.maxConcurrent && this.loadingQueue.length > 0) {
                    const imageRequest = this.loadingQueue.shift();
                    this.loadImageFromQueue(imageRequest);
                }
            }
            
            queueImage(img, priority = 'normal') {
                const src = img.dataset.src;
                if (!src || this.loadedImages.has(src) || this.pendingImages.has(src)) {
                    return;
                }
                
                const request = {
                    img,
                    src,
                    priority,
                    timestamp: Date.now()
                };
                
                if (priority === 'high') {
                    this.loadingQueue.unshift(request);
                } else {
                    this.loadingQueue.push(request);
                }
                
                this.pendingImages.set(src, request);
            }
            
            async loadImageFromQueue(request) {
                const { img, src } = request;
                this.currentLoading++;
                
                try {
                    await this.loadImageWithTimeout(img, src);
                    this.handleImageSuccess(img, src);
                } catch (error) {
                    this.handleImageError(img, src, error);
                } finally {
                    this.currentLoading--;
                    this.pendingImages.delete(src);
                }
            }
            
            loadImageWithTimeout(img, src) {
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Timeout'));
                    }, this.getTimeout());
                    
                    const tempImg = new Image();
                    
                    tempImg.onload = () => {
                        clearTimeout(timeout);
                        resolve(tempImg);
                    };
                    
                    tempImg.onerror = () => {
                        clearTimeout(timeout);
                        reject(new Error('Load failed'));
                    };
                    
                    // Set optimized loading attributes
                    tempImg.decoding = 'async';
                    tempImg.loading = 'eager';
                    tempImg.src = src;
                });
            }
            
            getTimeout() {
                switch (this.connectionQuality) {
                    case 'fast': return 5000;
                    case 'medium': return 8000;
                    case 'slow': return 12000;
                    default: return 7000;
                }
            }
            
            handleImageSuccess(img, src) {
                img.src = src;
                img.classList.remove('loading');
                img.classList.add('loaded');
                this.loadedImages.add(src);
                this.failedImages.delete(src);
                this.retryAttempts.delete(src);
                
                // Remove placeholder with animation
                const placeholder = img.parentElement?.querySelector('.image-placeholder');
                if (placeholder) {
                    placeholder.style.transition = 'opacity 0.3s ease';
                    placeholder.style.opacity = '0';
                    setTimeout(() => placeholder?.remove(), 300);
                }
                
                // Update image stats
                this.updateImageStats();
            }
            
            handleImageError(img, src, error) {
                const attempts = this.retryAttempts.get(src) || 0;
                
                if (attempts < this.maxRetries && navigator.onLine) {
                    // Retry with exponential backoff
                    this.retryAttempts.set(src, attempts + 1);
                    setTimeout(() => {
                        this.queueImage(img, 'normal');
                    }, Math.pow(2, attempts) * 1000);
                } else {
                    // Give up and show fallback
                    img.classList.remove('loading');
                    img.classList.add('error');
                    img.src = this.createFallbackImage();
                    this.failedImages.add(src);
                    this.updateImageStats();
                }
            }
            
            createFallbackImage() {
                return 'data:image/svg+xml;base64,' + btoa(`
                    <svg width="300" height="300" viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                        <rect width="300" height="300" fill="#f3f4f6"/>
                        <rect x="90" y="105" width="120" height="90" fill="#e5e7eb" rx="6"/>
                        <circle cx="120" cy="135" r="9" fill="#9ca3af"/>
                        <path d="M90 165l24-24 12 12 24-24 60 48v18H90z" fill="#9ca3af"/>
                        <text x="150" y="220" text-anchor="middle" fill="#6b7280" font-size="14" font-family="system-ui">
                            Image not available
                        </text>
                    </svg>
                `);
            }
            
            retryFailedImages() {
                const failedUrls = Array.from(this.failedImages);
                this.failedImages.clear();
                this.retryAttempts.clear();
                
                failedUrls.forEach(src => {
                    const imgs = document.querySelectorAll(`img[data-src="${src}"]`);
                    imgs.forEach(img => {
                        if (!img.classList.contains('loaded')) {
                            this.queueImage(img, 'normal');
                        }
                    });
                });
            }
            
            updateNetworkStatus() {
                if (debugMode) {
                    const statusEl = document.getElementById('network-status');
                    if (statusEl) {
                        statusEl.textContent = navigator.onLine ? 
                            this.connectionQuality.toUpperCase() : 'OFFLINE';
                    }
                }
            }
            
            updateImageStats() {
                if (debugMode) {
                    const loaded = this.loadedImages.size;
                    const failed = this.failedImages.size;
                    const total = loaded + failed;
                    
                    const statsEl = document.getElementById('image-stats');
                    if (statsEl) {
                        statsEl.textContent = `${loaded}/${total}`;
                    }
                }
            }
            
            destroy() {
                this.loadingQueue = [];
                this.pendingImages.clear();
                this.loadedImages.clear();
                this.failedImages.clear();
                this.retryAttempts.clear();
                console.log('üßπ Image loader destroyed and cleaned up');
            }
        }

        // ====================================
        // PERFORMANCE MONITOR CLASS
        // ====================================
        
        class PerformanceMonitor {
            constructor() {
                this.metrics = {
                    fps: 60,
                    frameCount: 0,
                    lastTime: performance.now(),
                    memoryUsage: 0,
                    domNodeCount: 0
                };
                
                this.isMonitoring = false;
                this.startMonitoring();
            }
            
            startMonitoring() {
                this.isMonitoring = true;
                this.updateFPS();
                this.updateMemoryUsage();
                
                // Update DOM count less frequently
                setInterval(() => {
                    this.updateDOMCount();
                }, 2000);
            }
            
            updateFPS() {
                if (!this.isMonitoring) return;
                
                const updateFrame = () => {
                    this.metrics.frameCount++;
                    const currentTime = performance.now();
                    
                    if (currentTime >= this.metrics.lastTime + 1000) {
                        this.metrics.fps = Math.round(
                            (this.metrics.frameCount * 1000) / (currentTime - this.metrics.lastTime)
                        );
                        this.metrics.frameCount = 0;
                        this.metrics.lastTime = currentTime;
                        
                        if (debugMode) {
                            const fpsEl = document.getElementById('fps-counter');
                            if (fpsEl) {
                                fpsEl.textContent = this.metrics.fps;
                                fpsEl.style.color = this.metrics.fps < 30 ? '#ef4444' : 
                                                  this.metrics.fps < 50 ? '#f59e0b' : '#10b981';
                            }
                        }
                    }
                    
                    requestAnimationFrame(updateFrame);
                };
                
                requestAnimationFrame(updateFrame);
            }
            
            updateMemoryUsage() {
                if (!this.isMonitoring) return;
                
                if ('memory' in performance) {
                    const memory = performance.memory;
                    this.metrics.memoryUsage = Math.round(memory.usedJSHeapSize / 1024 / 1024);
                    
                    if (debugMode) {
                        const memoryEl = document.getElementById('memory-usage');
                        if (memoryEl) {
                            memoryEl.textContent = `${this.metrics.memoryUsage} MB`;
                        }
                    }
                } else {
                    // Estimate memory usage
                    this.metrics.memoryUsage = Math.round(this.metrics.domNodeCount * 0.1);
                    
                    if (debugMode) {
                        const memoryEl = document.getElementById('memory-usage');
                        if (memoryEl) {
                            memoryEl.textContent = `~${this.metrics.memoryUsage} MB`;
                        }
                    }
                }
                
                setTimeout(() => {
                    this.updateMemoryUsage();
                }, 5000);
            }
            
            updateDOMCount() {
                this.metrics.domNodeCount = document.querySelectorAll('*').length;
                
                if (debugMode) {
                    const domEl = document.getElementById('dom-count');
                    if (domEl) {
                        domEl.textContent = this.metrics.domNodeCount.toLocaleString();
                        domEl.style.color = this.metrics.domNodeCount > 3000 ? '#ef4444' : 
                                          this.metrics.domNodeCount > 2000 ? '#f59e0b' : '#10b981';
                    }
                }
            }
            
            getMetrics() {
                return { ...this.metrics };
            }
            
            destroy() {
                this.isMonitoring = false;
                console.log('üßπ Performance monitor destroyed');
            }
        }

        // ====================================
        // MAIN APPLICATION LOGIC
        // ====================================
        
        // Global application state
        let shopData = null;
        let virtualScrollManager = null;
        let imageLoader = null;
        let performanceMonitor = null;
        let orderList = [];
        let debugMode = false;
        let currentFilter = 'all';
        let currentViewMode = 'virtual';
        let selectedOrderType = null;
        let isProcessingOrder = false;
        let loadedProductCount = 0;
        let totalProductCount = 0;

        // Initialize application when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('üöÄ Initializing Advanced Shop Profile...');
                
                // Initialize core systems
                imageLoader = new EnhancedImageLoader();
                performanceMonitor = new PerformanceMonitor();
                
                // Load shop data
                await loadShopData();
                
                // Set up event listeners
                setupEventListeners();
                
                console.log('‚úÖ Application initialized successfully!');
                console.log('üìä Features: Virtual scrolling, advanced image loading, performance monitoring');
                
            } catch (error) {
                console.error('‚ùå Failed to initialize application:', error);
                showError();
            }
        });

        // ====================================
        // DATA LOADING FUNCTIONS
        // ====================================
        
        async function loadShopData() {
            const urlParams = new URLSearchParams(window.location.search);
            
            try {
                const type = urlParams.get('type');
                const shopId = urlParams.get('shopId');
                const postId = urlParams.get('postId');
                
                if (!type || !shopId || !isValidUUID(shopId)) {
                    throw new Error('Invalid parameters');
                }
                
                if (postId && !isValidUUID(postId)) {
                    throw new Error('Invalid post ID');
                }

                let apiUrl = `https://rtwtkapynafirwixyeal.supabase.co/functions/v1/web-shopView?type=${type}&shopId=${shopId}`;
                if (postId) {
                    apiUrl += `&postId=${postId}`;
                }
                
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                shopData = await response.json();
                if (shopData.error) {
                    throw new Error(shopData.error);
                }
                
                // Preload critical images
                preloadCriticalImages();
                
                // Render shop profile
                renderShopProfile();
                
                // Hide loading and show content
                hideLoading();
                
            } catch (error) {
                console.error('Error loading shop data:', error);
                showError();
            }
        }

        function preloadCriticalImages() {
            if (!shopData?.shop) return;
            
            const criticalImages = [];
            
            // Shop images
            if (shopData.shop.coverImage) {
                criticalImages.push(shopData.shop.coverImage);
            }
            if (shopData.shop.profileImage) {
                criticalImages.push(shopData.shop.profileImage);
            }
            
            // First few product images
            if (shopData.products?.length > 0) {
                shopData.products.slice(0, 6).forEach(product => {
                    const media = product.media?.[0];
                    if (media?.thumbnailUrl || media?.url) {
                        criticalImages.push(media.thumbnailUrl || media.url);
                    }
                });
            }
            
            // Preload using link tags for better performance
            criticalImages.forEach(url => {
                const link = document.createElement('link');
                link.rel = 'preload';
                link.as = 'image';
                link.href = url;
                document.head.appendChild(link);
            });
        }

        function renderShopProfile() {
            const { shop, products = [], discounts = [], subcategories = [], stats } = shopData;
            
            // Update page metadata
            document.title = `${shop.name} - Knoc`;
            const metaDesc = document.querySelector('meta[name="description"]');
            if (metaDesc) {
                metaDesc.content = `Shop ${shop.name} on Knoc. ${shop.description || 'Discover amazing products'}`;
            }
            
            // Load critical images immediately
            if (shop.coverImage) {
                const coverImg = document.getElementById('cover-image');
                coverImg.src = shop.coverImage;
                coverImg.classList.add('loaded');
            }
            
            const profileImg = document.getElementById('profile-image');
            const profileImageUrl = shop.profileImage || 'https://www.knoc.in/knoc_logo.png';
            profileImg.src = profileImageUrl;
            profileImg.classList.add('loaded');
            
            // Update shop information
            document.getElementById('shop-name').textContent = shop.name;
            document.getElementById('shop-description').textContent = shop.description || 'Welcome to our shop! Discover amazing products and great deals.';
            document.getElementById('shop-rating').textContent = (shop.rating || 4.9).toFixed(1);
            document.getElementById('follower-count').textContent = formatNumber(shop.followerCount || 0);
            document.getElementById('product-count').textContent = formatNumber(stats?.totalProducts || products.length);
            document.getElementById('orders-count').textContent = formatNumber(stats?.totalOrders || 0);

            // Show verified badge if applicable
            if (shop.verifiedAt) {
                document.getElementById('verified-badge').classList.remove('hidden');
            }

            // Show promotion banner if discounts available
            if (discounts.length > 0) {
                showPromotionBanner(discounts[0]);
            }

            // Render categories
            renderCategories(subcategories, products);
            
            // Update product counts
            totalProductCount = products.length;
            updateProductCounts();
            
            // Initialize virtual scrolling
            initializeVirtualScrolling(products);
        }

        function showPromotionBanner(discount) {
            const banner = document.getElementById('promotion-banner');
            const title = document.getElementById('promotion-title');
            const description = document.getElementById('promotion-description');
            const percent = document.getElementById('promotion-percent');
            
            title.textContent = discount.title || 'Special Offer';
            description.textContent = discount.description || 'Limited time only!';
            
            if (discount.discount_percent) {
                percent.textContent = `${Math.round(discount.discount_percent)}%`;
            }
            
            banner.classList.remove('hidden');
            banner.classList.add('fade-in');
        }

        function renderCategories(subcategories, products) {
            const container = document.getElementById('categories-container');
            const allButton = container.querySelector('[data-category="all"]');
            
            // Clear existing categories except "All"
            const existingCategories = container.querySelectorAll('button:not([data-category="all"])');
            existingCategories.forEach(btn => btn.remove());
            
            // Add subcategories
            subcategories.forEach(sub => {
                const productCount = products.filter(p => p.subcategoryId === sub.id).length;
                if (productCount > 0) {
                    const button = document.createElement('button');
                    button.className = 'category-chip bg-white border border-gray-200 text-gray-700 hover:border-red-300 transition-all';
                    button.innerHTML = `
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                        ${sub.name} (${productCount})
                    `;
                    button.dataset.category = sub.id;
                    button.onclick = () => filterProducts(sub.id);
                    container.appendChild(button);
                }
            });
            
            // Add uncategorized if exists
            const uncategorizedCount = products.filter(p => !p.subcategoryId).length;
            if (uncategorizedCount > 0) {
                const button = document.createElement('button');
                button.className = 'category-chip bg-white border border-gray-200 text-gray-700 hover:border-red-300 transition-all';
                button.innerHTML = `
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14-7H5m14 14H5"></path>
                    </svg>
                    Other (${uncategorizedCount})
                `;
                button.dataset.category = 'uncategorized';
                button.onclick = () => filterProducts('uncategorized');
                container.appendChild(button);
            }
            
            // Update "All" button text
            allButton.innerHTML = `
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14-7H5m14 14H5"></path>
                </svg>
                All Products (${products.length})
            `;
            allButton.onclick = () => filterProducts('all');
        }

        function updateProductCounts() {
            const showingEl = document.getElementById('showing-count');
            const totalEl = document.getElementById('total-count');
            
            if (showingEl) showingEl.textContent = loadedProductCount;
            if (totalEl) totalEl.textContent = totalProductCount;
            
            // Update subtitle
            const subtitle = document.getElementById('products-subtitle');
            if (subtitle) {
                if (totalProductCount === 0) {
                    subtitle.textContent = 'No products available';
                } else if (totalProductCount === 1) {
                    subtitle.textContent = '1 amazing product';
                } else {
                    subtitle.textContent = `${totalProductCount} amazing products`;
                }
            }
        }

        // ====================================
        // VIRTUAL SCROLLING INITIALIZATION
        // ====================================
        
        function initializeVirtualScrolling(products) {
            const virtualContainer = document.getElementById('virtual-container');
            const traditionalContainer = document.getElementById('traditional-container');
            const hybridContainer = document.getElementById('hybrid-container');
            const viewModeSelect = document.getElementById('view-mode');
            
            // Clean up existing manager
            if (virtualScrollManager) {
                virtualScrollManager.destroy();
                virtualScrollManager = null;
            }
            
            // Hide all containers
            virtualContainer.classList.add('hidden');
            traditionalContainer.classList.add('hidden');
            hybridContainer.classList.add('hidden');
            
            currentViewMode = viewModeSelect.value;
            
            if (products.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }
            
            document.getElementById('empty-state').classList.add('hidden');
            
            switch (currentViewMode) {
                case 'virtual':
                    initVirtualMode(products, virtualContainer);
                    break;
                case 'traditional':
                    initTraditionalMode(products, traditionalContainer);
                    break;
                case 'hybrid':
                    initHybridMode(products, hybridContainer);
                    break;
                default:
                    initVirtualMode(products, virtualContainer);
            }
            
            loadedProductCount = products.length;
            updateProductCounts();
        }

        function initVirtualMode(products, container) {
            container.classList.remove('hidden');
            
            const itemHeight = window.innerWidth < 640 ? 160 : 180;
            virtualScrollManager = new AdvancedVirtualScrollManager(container, {
                itemHeight,
                tolerance: 8,
               preloadBatch: 20,
               maxPoolSize: 50
           });
           
           virtualScrollManager.setItems(products);
           
           console.log(`üöÄ Virtual scrolling initialized with ${products.length} products`);
       }

       function initTraditionalMode(products, container) {
           container.classList.remove('hidden');
           
           const productGrid = container.querySelector('.product-grid');
           productGrid.innerHTML = '';
           
           // Load products in batches for better performance
           const batchSize = 20;
           let currentBatch = 0;
           
           function loadBatch() {
               const start = currentBatch * batchSize;
               const end = Math.min(start + batchSize, products.length);
               
               for (let i = start; i < end; i++) {
                   const productCard = createProductCard(products[i]);
                   productGrid.appendChild(productCard);
               }
               
               // Initialize lazy loading for new images
               const newImages = productGrid.querySelectorAll('.lazy-image[data-src]:not(.observed)');
               newImages.forEach(img => {
                   img.classList.add('observed');
                   imageLoader.queueImage(img, 'normal');
               });
               
               currentBatch++;
               
               // Show load more button if there are more products
               const loadMoreContainer = document.getElementById('load-more-container');
               if (end < products.length) {
                   loadMoreContainer.classList.remove('hidden');
               } else {
                   loadMoreContainer.classList.add('hidden');
               }
           }
           
           // Load first batch
           loadBatch();
           
           // Store loadBatch function for load more button
           window.loadMoreProducts = loadBatch;
           
           console.log(`üìã Traditional mode initialized with ${products.length} products`);
       }

       function initHybridMode(products, container) {
           container.classList.remove('hidden');
           
           const immediateContainer = container.querySelector('#immediate-products');
           const hybridVirtualContent = container.querySelector('#hybrid-virtual-content');
           
           // Load first 6 products immediately (above fold)
           const immediateProducts = products.slice(0, 6);
           const virtualProducts = products.slice(6);
           
           // Render immediate products
           immediateContainer.innerHTML = '';
           immediateProducts.forEach(product => {
               const productCard = createProductCard(product);
               immediateContainer.appendChild(productCard);
           });
           
           // Initialize lazy loading for immediate products
           const immediateImages = immediateContainer.querySelectorAll('.lazy-image[data-src]');
           immediateImages.forEach(img => {
               imageLoader.queueImage(img, 'high');
           });
           
           // Initialize virtual scrolling for remaining products
           if (virtualProducts.length > 0) {
               const hybridContainer = container.querySelector('.virtual-scroll-container');
               const hybridManager = new AdvancedVirtualScrollManager(hybridContainer, {
                   itemHeight: 180,
                   tolerance: 5
               });
               hybridManager.setItems(virtualProducts);
           }
           
           console.log(`‚ö° Hybrid mode initialized: ${immediateProducts.length} immediate + ${virtualProducts.length} virtual`);
       }

       function createProductCard(product) {
           const { metadata = {} } = product;
           const media = product.media && product.media.length > 0 ? product.media[0] : null;
           const imageUrl = media ? (media.thumbnailUrl || media.url) : null;
           
           const productName = metadata.product_name || product.content || '';
           const originalPrice = metadata.price;
           const discountedPrice = metadata.discounted_price;
           const displayPrice = discountedPrice || originalPrice;
           
           const isOrderable = canOrderProduct(product);
           const hasDiscount = discountedPrice && originalPrice && discountedPrice < originalPrice;
           const discountPercent = hasDiscount ? Math.round(((originalPrice - discountedPrice) / originalPrice) * 100) : 0;

           const card = document.createElement('div');
           card.className = 'product-card bg-white rounded-xl shadow-sm overflow-hidden relative critical-render fade-in';
           
           card.innerHTML = `
               <div class="image-container relative bg-gray-100">
                   ${imageUrl ? `
                       <div class="image-placeholder">
                           <div class="skeleton w-8 h-8 rounded"></div>
                       </div>
                       <img src="" 
                            data-src="${imageUrl}"
                            alt="${escapeHtml(productName)}" 
                            class="lazy-image w-full h-full object-cover"
                            loading="lazy"
                            decoding="async"
                            width="300"
                            height="300">
                   ` : `
                       <div class="w-full h-full flex items-center justify-center">
                           <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 18m-2-5V9a2 2 0 00-2-2H8a2 2 0 00-2 2v.01"></path>
                           </svg>
                       </div>
                   `}
                   ${hasDiscount ? `
                       <div class="absolute top-2 left-2 bg-gradient-to-r from-red-500 to-red-600 text-white text-xs px-2 py-1 rounded-lg font-bold shadow-sm">
                           ${discountPercent}% OFF
                       </div>
                   ` : ''}
                   <div class="absolute top-2 right-2 w-8 h-8 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity cursor-pointer" onclick="toggleWishlist('${product.id}')">
                       <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                       </svg>
                   </div>
               </div>
               
               <div class="p-3">
                   <h3 class="font-medium text-gray-900 text-sm mb-2 line-clamp-2 leading-tight">${escapeHtml(productName) || 'Product Name Not Available'}</h3>
                   
                   <div class="flex items-center justify-between">
                       <div class="flex flex-col">
                           ${isOrderable ? `
                               <div class="flex items-center space-x-2">
                                   <span class="text-red-600 font-bold text-lg">‚Çπ${Math.round(displayPrice)}</span>
                                   ${hasDiscount ? `
                                       <span class="text-gray-400 text-sm line-through">‚Çπ${Math.round(originalPrice)}</span>
                                   ` : ''}
                               </div>
                           ` : `
                               <span class="text-gray-400 text-sm">Price not available</span>
                           `}
                       </div>
                       ${isOrderable ? `
                           <button onclick="addToOrder(${escapeJson(product)})" 
                                   class="btn btn-primary px-3 py-1.5 text-sm font-medium rounded-lg transition-all hover:scale-105 focus:scale-95">
                               <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                               </svg>
                               Add
                           </button>
                       ` : `
                           <button disabled class="bg-gray-300 text-gray-500 px-3 py-1.5 rounded-lg text-sm font-medium cursor-not-allowed">
                               Unavailable
                           </button>
                       `}
                   </div>
               </div>
           `;
           
           return card;
       }

       // ====================================
       // EVENT LISTENERS SETUP
       // ====================================
       
       function setupEventListeners() {
           // View mode change
           document.getElementById('view-mode').addEventListener('change', handleViewModeChange);
           
           // Sort change
           document.getElementById('sort-select').addEventListener('change', handleSortChange);
           
           // Share functionality
           document.getElementById('share-btn').addEventListener('click', handleShare);
           
           // Close modals when clicking outside
           document.addEventListener('click', handleModalClicks);
           
           // Handle keyboard navigation
           document.addEventListener('keydown', handleKeyboardNavigation);
           
           // Prevent memory leaks on page unload
           window.addEventListener('beforeunload', handlePageUnload);
           
           // Handle visibility change for performance optimization
           document.addEventListener('visibilitychange', handleVisibilityChange);
           
           // Handle online/offline status
           window.addEventListener('online', handleOnlineStatus);
           window.addEventListener('offline', handleOfflineStatus);
       }

       function handleViewModeChange(e) {
           const newMode = e.target.value;
           if (newMode !== currentViewMode && shopData?.products) {
               currentViewMode = newMode;
               initializeVirtualScrolling(getFilteredProducts());
               
               showToast(
                   'View Changed', 
                   `Switched to ${newMode} mode`, 
                   'info'
               );
           }
       }

       function handleSortChange(e) {
           const sortBy = e.target.value;
           if (shopData?.products) {
               const sortedProducts = sortProducts(getFilteredProducts(), sortBy);
               initializeVirtualScrolling(sortedProducts);
               
               showToast(
                   'Products Sorted', 
                   `Sorted by ${e.target.options[e.target.selectedIndex].text}`, 
                   'info'
               );
           }
       }

       function handleModalClicks(e) {
           if (e.target.classList.contains('modal-overlay')) {
               closeOrderModal();
               closeOrderTypeModal();
               closeTableModal();
               closeAddressModal();
           }
       }

       function handleKeyboardNavigation(e) {
           if (e.key === 'Escape') {
               closeOrderModal();
               closeOrderTypeModal();
               closeTableModal();
               closeAddressModal();
           }
           
           if (e.key === 'Enter' && !isProcessingOrder) {
               if (e.target.id === 'table-number') {
                   confirmDineInOrder();
               } else if (e.target.id === 'delivery-address' || e.target.id === 'customer-phone') {
                   confirmDeliveryOrder();
               }
           }
       }

       function handlePageUnload() {
           // Clean up resources
           if (virtualScrollManager) {
               virtualScrollManager.destroy();
           }
           if (imageLoader) {
               imageLoader.destroy();
           }
           if (performanceMonitor) {
               performanceMonitor.destroy();
           }
           
           console.log('üßπ Page unload cleanup completed');
       }

       function handleVisibilityChange() {
           if (document.hidden) {
               // Pause non-essential operations when tab is hidden
               console.log('‚è∏Ô∏è Tab hidden - pausing operations');
           } else {
               // Resume operations when tab becomes visible
               console.log('‚ñ∂Ô∏è Tab visible - resuming operations');
               if (virtualScrollManager) {
                   virtualScrollManager.refresh();
               }
           }
       }

       function handleOnlineStatus() {
           showToast('Connection Restored', 'You are back online', 'success');
           if (imageLoader) {
               imageLoader.retryFailedImages();
           }
       }

       function handleOfflineStatus() {
           showToast('Connection Lost', 'You are offline', 'error');
       }

       // ====================================
       // PRODUCT FILTERING AND SORTING
       // ====================================
       
       function filterProducts(categoryId) {
           currentFilter = categoryId;
           
           // Update category chips
           document.querySelectorAll('.category-chip').forEach(chip => {
               if (chip.dataset.category === categoryId) {
                   chip.className = 'category-chip active';
               } else {
                   chip.className = 'category-chip bg-white border border-gray-200 text-gray-700 hover:border-red-300 transition-all';
               }
           });

           const filteredProducts = getFilteredProducts();
           const sortBy = document.getElementById('sort-select').value;
           const sortedProducts = sortProducts(filteredProducts, sortBy);
           
           initializeVirtualScrolling(sortedProducts);
           
           showToast(
               'Filter Applied', 
               `Showing ${sortedProducts.length} products`, 
               'info'
           );
       }

       function getFilteredProducts() {
           if (!shopData?.products) return [];
           
           if (currentFilter === 'all') {
               return shopData.products;
           } else if (currentFilter === 'uncategorized') {
               return shopData.products.filter(p => !p.subcategoryId);
           } else {
               return shopData.products.filter(p => p.subcategoryId === currentFilter);
           }
       }

       function sortProducts(products, sortBy) {
           const sorted = [...products];
           
           switch (sortBy) {
               case 'price-low':
                   return sorted.sort((a, b) => {
                       const priceA = a.metadata?.discounted_price || a.metadata?.price || 0;
                       const priceB = b.metadata?.discounted_price || b.metadata?.price || 0;
                       return priceA - priceB;
                   });
                   
               case 'price-high':
                   return sorted.sort((a, b) => {
                       const priceA = a.metadata?.discounted_price || a.metadata?.price || 0;
                       const priceB = b.metadata?.discounted_price || b.metadata?.price || 0;
                       return priceB - priceA;
                   });
                   
               case 'name':
                   return sorted.sort((a, b) => {
                       const nameA = a.metadata?.product_name || a.content || '';
                       const nameB = b.metadata?.product_name || b.content || '';
                       return nameA.localeCompare(nameB);
                   });
                   
               case 'popularity':
                   return sorted.sort((a, b) => {
                       // Sort by some popularity metric (you can customize this)
                       return (b.metadata?.orders_count || 0) - (a.metadata?.orders_count || 0);
                   });
                   
               default:
                   return sorted;
           }
       }

       // ====================================
       // ORDER MANAGEMENT
       // ====================================
       
       function addToOrder(product) {
           if (!canOrderProduct(product)) {
               showToast('Cannot Add', 'This product is not available for ordering', 'error');
               return;
           }

           const { metadata = {} } = product;
           const productName = metadata.product_name || product.content;
           const originalPrice = metadata.price;
           const discountedPrice = metadata.discounted_price;
           const displayPrice = discountedPrice || originalPrice;

           const orderItem = {
               id: product.id,
               name: productName,
               price: displayPrice,
               quantity: 1,
               image: product.media?.[0]?.thumbnailUrl || product.media?.[0]?.url
           };

           const existingIndex = orderList.findIndex(item => item.id === product.id);
           
           if (existingIndex !== -1) {
               orderList[existingIndex].quantity++;
               showToast('Quantity Updated', `${productName} quantity increased`, 'success');
           } else {
               orderList.push(orderItem);
               showToast('Added to Cart', `${productName} added to your order`, 'success');
           }

           updateOrderUI();
           
           // Add pulse animation to cart button
           const floatingCart = document.getElementById('floating-cart');
           floatingCart.classList.add('pulse');
           setTimeout(() => {
               floatingCart.classList.remove('pulse');
           }, 600);
       }

       function removeFromOrder(productId) {
           const index = orderList.findIndex(item => item.id === productId);
           if (index !== -1) {
               const item = orderList[index];
               if (item.quantity > 1) {
                   item.quantity--;
                   showToast('Quantity Updated', `${item.name} quantity decreased`, 'info');
               } else {
                   orderList.splice(index, 1);
                   showToast('Removed from Cart', `${item.name} removed from your order`, 'info');
               }
               updateOrderUI();
           }
       }

       function updateOrderUI() {
           const orderCount = orderList.reduce((total, item) => total + item.quantity, 0);
           const floatingCart = document.getElementById('floating-cart');
           const floatingCartCount = document.getElementById('floating-cart-count');
           
           if (orderCount > 0) {
               floatingCart.classList.remove('hidden');
               floatingCartCount.textContent = orderCount;
               floatingCartCount.classList.add('fade-in');
           } else {
               floatingCart.classList.add('hidden');
           }

           updateOrderModal();
       }

       function updateOrderModal() {
           const orderListEl = document.getElementById('order-list');
           const orderEmpty = document.getElementById('order-empty');
           const orderFooter = document.getElementById('order-footer');
           const orderTotal = document.getElementById('order-total');

           if (orderList.length === 0) {
               orderListEl.innerHTML = '';
               orderEmpty.classList.remove('hidden');
               orderFooter.classList.add('hidden');
               return;
           }

           orderEmpty.classList.add('hidden');
           orderFooter.classList.remove('hidden');

           const total = orderList.reduce((sum, item) => sum + (item.price * item.quantity), 0);
           orderTotal.textContent = `‚Çπ${Math.round(total)}`;

           orderListEl.innerHTML = orderList.map(item => `
               <div class="flex items-center p-4 bg-gray-50 rounded-xl border border-gray-100 hover:bg-gray-100 transition-colors">
                   <div class="w-16 h-16 bg-gray-200 rounded-lg overflow-hidden mr-4 flex-shrink-0">
                       ${item.image ? `
                           <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">
                       ` : `
                           <div class="w-full h-full flex items-center justify-center">
                               <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                               </svg>
                           </div>
                       `}
                   </div>
                   <div class="flex-1 min-w-0">
                       <h4 class="font-medium text-gray-900 text-sm mb-1 truncate">${escapeHtml(item.name)}</h4>
                       <p class="text-red-600 font-bold text-lg">‚Çπ${Math.round(item.price)}</p>
                   </div>
                   <div class="flex items-center space-x-3 ml-4">
                       <button onclick="removeFromOrder('${item.id}')" class="w-8 h-8 bg-red-100 text-red-600 rounded-full flex items-center justify-center hover:bg-red-200 transition-colors">
                           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                           </svg>
                       </button>
                       <span class="font-bold text-gray-900 min-w-[24px] text-center">${item.quantity}</span>
                       <button onclick="addToOrderFromModal('${item.id}')" class="w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center hover:bg-green-200 transition-colors">
                           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                           </svg>
                       </button>
                   </div>
               </div>
           `).join('');
       }

       function addToOrderFromModal(productId) {
           const product = shopData.products.find(p => p.id === productId);
           if (product) {
               addToOrder(product);
           }
       }

       function openOrderModal() {
           document.getElementById('order-modal').classList.remove('hidden');
           updateOrderModal();
       }

       function closeOrderModal() {
           document.getElementById('order-modal').classList.add('hidden');
       }

       function proceedToOrder() {
           if (orderList.length === 0) {
               showToast('Empty Cart', 'Please add some items to your cart first', 'error');
               return;
           }
           
           closeOrderModal();
           openOrderTypeModal();
       }

       function openOrderTypeModal() {
           document.getElementById('order-type-modal').classList.remove('hidden');
       }

       function closeOrderTypeModal() {
           document.getElementById('order-type-modal').classList.add('hidden');
       }

       function selectOrderType(type) {
           selectedOrderType = type;
           closeOrderTypeModal();
           
           if (type === 'dine_in') {
               openTableModal();
           } else if (type === 'delivery') {
               openAddressModal();
           }
       }

       function openTableModal() {
           document.getElementById('table-modal').classList.remove('hidden');
           setTimeout(() => {
               document.getElementById('table-number').focus();
           }, 100);
       }

       function closeTableModal() {
           document.getElementById('table-modal').classList.add('hidden');
       }

       function openAddressModal() {
           document.getElementById('address-modal').classList.remove('hidden');
           setTimeout(() => {
               document.getElementById('delivery-address').focus();
           }, 100);
       }

       function closeAddressModal() {
           document.getElementById('address-modal').classList.add('hidden');
       }

       // ====================================
       // ORDER PROCESSING
       // ====================================
       
       async function confirmDineInOrder() {
           if (isProcessingOrder) return;
           
           const tableNumber = document.getElementById('table-number').value.trim();
           const notes = document.getElementById('order-notes').value.trim();
           
           if (!tableNumber) {
               showToast('Missing Information', 'Please enter a table number', 'error');
               document.getElementById('table-number').focus();
               return;
           }

           isProcessingOrder = true;
           setButtonLoading('confirm-dine-btn', true);

           const orderData = {
               shop_id: shopData.shop.id,
               order_type: 'dine_in',
               table_number: tableNumber,
               order_items: orderList.map(item => ({
                   name: item.name,
                   price: item.price,
                   quantity: item.quantity
               })),
               total_amount: orderList.reduce((sum, item) => sum + (item.price * item.quantity), 0),
               notes: notes || null,
               timestamp: new Date().toISOString()
           };

           try {
               const response = await fetch('https://rtwtkapynafirwixyeal.supabase.co/functions/v1/Food-AddItem', {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json',
                   },
                   body: JSON.stringify(orderData)
               });

               const result = await response.json();
               
               if (result.success || response.ok) {
                   showToast(
                       'Order Confirmed!', 
                       'Your dine-in order has been placed successfully. The restaurant will prepare your order.', 
                       'success'
                   );
                   
                   // Clear order and close modal
                   orderList = [];
                   updateOrderUI();
                   closeTableModal();
                   
                   // Clear form
                   document.getElementById('table-number').value = '';
                   document.getElementById('order-notes').value = '';
               } else {
                   throw new Error(result.error || 'Failed to place order');
               }
           } catch (error) {
               console.error('Error placing order:', error);
               showToast(
                   'Order Failed', 
                   'Failed to place order. Please try again or contact the restaurant directly.', 
                   'error'
               );
           } finally {
               isProcessingOrder = false;
               setButtonLoading('confirm-dine-btn', false);
           }
       }

       async function confirmDeliveryOrder() {
           if (isProcessingOrder) return;
           
           const address = document.getElementById('delivery-address').value.trim();
           const phone = document.getElementById('customer-phone').value.trim();
           const notes = document.getElementById('delivery-notes').value.trim();
           
           if (!address) {
               showToast('Missing Information', 'Please enter a delivery address', 'error');
               document.getElementById('delivery-address').focus();
               return;
           }
           
           if (!phone) {
               showToast('Missing Information', 'Please enter your phone number', 'error');
               document.getElementById('customer-phone').focus();
               return;
           }

           isProcessingOrder = true;
           setButtonLoading('confirm-delivery-btn', true);

           const orderData = {
               shop_id: shopData.shop.id,
               order_type: 'delivery',
               customer_address: address,
               customer_phone: phone,
               order_items: orderList.map(item => ({
                   name: item.name,
                   price: item.price,
                   quantity: item.quantity
               })),
               total_amount: orderList.reduce((sum, item) => sum + (item.price * item.quantity), 0),
               notes: notes || null,
               timestamp: new Date().toISOString()
           };

           try {
               // Send order to backend (fire and forget)
               fetch('https://rtwtkapynafirwixyeal.supabase.co/functions/v1/Food-AddItem', {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json',
                   },
                   body: JSON.stringify(orderData)
               }).catch(error => {
                   console.error('Background API error:', error);
               });
               
               // Generate WhatsApp message
               const message = generateDeliveryOrderMessage(orderData);
               const shopContact = shopData.shop.contact?.phone;
               
               if (shopContact) {
                   const whatsappUrl = generateWhatsAppLink(shopContact, message);
                   
                   // Open WhatsApp
                   setTimeout(() => {
                       openWhatsApp(whatsappUrl, message);
                       
                       showToast(
                           'Order Sent!', 
                           'Your delivery order has been sent via WhatsApp. Please check your WhatsApp for confirmation.', 
                           'success'
                       );
                       
                       // Clear order and close modal
                       orderList = [];
                       updateOrderUI();
                       closeAddressModal();
                       
                       // Clear form
                       document.getElementById('delivery-address').value = '';
                       document.getElementById('customer-phone').value = '';
                       document.getElementById('delivery-notes').value = '';
                       
                   }, 500);
               } else {
                   throw new Error('Restaurant contact information is not available');
               }
           } catch (error) {
               console.error('Error in delivery order process:', error);
               showToast(
                   'Order Failed', 
                   error.message || 'Failed to process delivery order. Please try again later.', 
                   'error'
               );
           } finally {
               isProcessingOrder = false;
               setButtonLoading('confirm-delivery-btn', false);
           }
       }

       function generateDeliveryOrderMessage(orderData) {
           const shopName = shopData.shop.name;
           
           let message = `üõçÔ∏è *New Delivery Order - ${shopName}*\n\n`;
           
           message += `üìù *Items (${orderData.order_items.length}):*\n`;
           orderData.order_items.forEach((item, index) => {
               message += `${index + 1}. ${item.name} √ó ${item.quantity} = ‚Çπ${Math.round(item.price * item.quantity)}\n`;
           });
           
           message += `\nüí∞ *Total: ‚Çπ${Math.round(orderData.total_amount)}*\n\n`;
           
           message += `üìç *Delivery Address:*\n${orderData.customer_address}\n\n`;
           
           if (orderData.customer_phone) {
               message += `üìû *Phone:* ${orderData.customer_phone}\n\n`;
           }
           
           if (orderData.notes) {
               message += `üìù *Special Instructions:*\n${orderData.notes}\n\n`;
           }
           
           message += `üïí *Order Time:* ${new Date().toLocaleString()}\n`;
           message += `\n*Ordered via:* ${window.location.href}`;
           
           return message;
       }

       function generateWhatsAppLink(phoneNumber, message) {
           const deviceInfo = getDeviceInfo();
           const encodedMessage = encodeURIComponent(message);
           
           const cleanPhone = phoneNumber.replace(/[^\d+]/g, '');
           let formattedPhone;
           
           if (cleanPhone.startsWith('+')) {
               formattedPhone = cleanPhone.substring(1);
           } else if (cleanPhone.startsWith('91') && cleanPhone.length === 12) {
               formattedPhone = cleanPhone;
           } else if (cleanPhone.length === 10) {
               formattedPhone = '91' + cleanPhone;
           } else {
               formattedPhone = cleanPhone;
           }
if (deviceInfo.isIOS) {
               return `whatsapp://send?phone=${formattedPhone}&text=${encodedMessage}`;
           } else {
               return `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
           }
       }

       function openWhatsApp(url, fallbackMessage) {
           const deviceInfo = getDeviceInfo();
           
           try {
               if (deviceInfo.isMobile) {
                   window.location.href = url;
                   
                   setTimeout(() => {
                       showToast(
                           'WhatsApp Link', 
                           'If WhatsApp didn\'t open, please install WhatsApp or try copying the message manually', 
                           'info'
                       );
                   }, 3000);
               } else {
                   const whatsappWindow = window.open(url, '_blank');
                   
                   if (!whatsappWindow) {
                       copyToClipboard(fallbackMessage);
                       showToast(
                           'Link Copied', 
                           'WhatsApp link copied to clipboard. Please paste it in WhatsApp Web or your WhatsApp app.', 
                           'info'
                       );
                   }
               }
           } catch (error) {
               console.error('Error opening WhatsApp:', error);
               copyToClipboard(fallbackMessage);
               showToast(
                   'Error', 
                   'Unable to open WhatsApp. Message copied to clipboard.', 
                   'error'
               );
           }
       }

       // ====================================
       // UTILITY FUNCTIONS
       // ====================================
       
       function canOrderProduct(product) {
           const { metadata = {} } = product;
           const productName = metadata.product_name || product.content;
           const price = metadata.price;
           return productName && productName.trim() !== '' && price && price > 0;
       }

       function isValidUUID(uuid) {
           const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
           return uuidPattern.test(uuid);
       }

       function formatNumber(num) {
           if (num >= 1000000) {
               return (num / 1000000).toFixed(1) + 'M';
           }
           if (num >= 1000) {
               return (num / 1000).toFixed(1) + 'K';
           }
           return num.toLocaleString();
       }

       function escapeHtml(text) {
           if (!text) return '';
           const div = document.createElement('div');
           div.textContent = text;
           return div.innerHTML;
       }

       function escapeJson(obj) {
           return JSON.stringify(obj).replace(/"/g, '&quot;');
       }

       function getDeviceInfo() {
           const userAgent = navigator.userAgent.toLowerCase();
           const platform = navigator.platform.toLowerCase();
           
           return {
               isIOS: /ipad|iphone|ipod/.test(userAgent) || (platform === 'macintel' && navigator.maxTouchPoints > 1),
               isAndroid: /android/.test(userAgent),
               isMobile: /mobile|tablet|ipad|iphone|ipod/.test(userAgent) || window.innerWidth < 768,
               isDesktop: !/mobile|tablet|ipad|iphone|ipod/.test(userAgent) && window.innerWidth >= 768
           };
       }

       function setButtonLoading(buttonId, isLoading) {
           const button = document.getElementById(buttonId);
           if (!button) return;
           
           const btnText = button.querySelector('.btn-text');
           const spinner = button.querySelector('.loading-spinner');
           
           if (isLoading) {
               button.classList.add('btn-loading');
               button.disabled = true;
               if (btnText) btnText.classList.add('hidden');
               if (spinner) spinner.classList.remove('hidden');
           } else {
               button.classList.remove('btn-loading');
               button.disabled = false;
               if (btnText) btnText.classList.remove('hidden');
               if (spinner) spinner.classList.add('hidden');
           }
       }

       function hideLoading() {
           document.getElementById('loading').classList.add('hidden');
           document.getElementById('content').classList.remove('hidden');
       }

       function showError() {
           document.getElementById('loading').classList.add('hidden');
           document.getElementById('error').classList.remove('hidden');
       }

       function toggleWishlist(productId) {
           // Placeholder for wishlist functionality
           showToast('Wishlist', 'Wishlist feature coming soon!', 'info');
       }

       function downloadApp() {
           const deviceInfo = getDeviceInfo();
           
           if (deviceInfo.isAndroid) {
               window.open('https://play.google.com/store/apps/details?id=com.knoc.app', '_blank');
           } else if (deviceInfo.isIOS) {
               showToast('Download App', 'iOS app will be available soon! Android app is available now.', 'info');
           } else {
               showToast('Download App', 'Knoc mobile app is available for Android and iOS devices.', 'info');
           }
       }

       function toggleDebugMode() {
           debugMode = !debugMode;
           
           const perfMonitor = document.getElementById('performance-monitor');
           const debugInfo = document.getElementById('debug-info');
           
           if (debugMode) {
               perfMonitor.classList.add('show');
               debugInfo.classList.add('show');
               showToast('Debug Mode', 'Performance monitoring enabled', 'info');
               
               // Update debug info if virtual scroll manager exists
               if (virtualScrollManager) {
                   virtualScrollManager.updateDebugInfo();
               }
           } else {
               perfMonitor.classList.remove('show');
               debugInfo.classList.remove('show');
               showToast('Debug Mode', 'Performance monitoring disabled', 'info');
           }
       }

       async function handleShare() {
           if (!shopData) return;
           
           const shareData = {
               title: shopData.shop.name,
               text: shopData.shop.description || `Check out ${shopData.shop.name} on Knoc!`,
               url: window.location.href
           };
           
           if (navigator.share) {
               try {
                   await navigator.share(shareData);
                   showToast('Shared!', 'Shop link shared successfully', 'success');
               } catch (err) {
                   if (err.name !== 'AbortError') {
                       copyToClipboard(window.location.href);
                   }
               }
           } else {
               copyToClipboard(window.location.href);
           }
       }

       function copyToClipboard(text) {
           if (navigator.clipboard) {
               navigator.clipboard.writeText(text).then(() => {
                   showToast('Link Copied!', 'Shop link copied to clipboard', 'success');
               }).catch(() => {
                   fallbackCopyTextToClipboard(text);
               });
           } else {
               fallbackCopyTextToClipboard(text);
           }
       }

       function fallbackCopyTextToClipboard(text) {
           const textArea = document.createElement('textarea');
           textArea.value = text;
           textArea.style.position = 'fixed';
           textArea.style.left = '-999999px';
           textArea.style.top = '-999999px';
           document.body.appendChild(textArea);
           textArea.focus();
           textArea.select();
           
           try {
               document.execCommand('copy');
               showToast('Link Copied!', 'Shop link copied to clipboard', 'success');
           } catch (err) {
               showToast('Copy Failed', 'Unable to copy text. Please copy manually.', 'error');
           }
           
           document.body.removeChild(textArea);
       }

       function showToast(title, message, type = 'success') {
           const toast = document.getElementById('toast');
           const toastContent = document.getElementById('toast-content');
           const toastIcon = document.getElementById('toast-icon');
           const toastTitle = document.getElementById('toast-title');
           const toastMessage = document.getElementById('toast-message');
           
           // Update content class for styling
           toastContent.className = `toast-content ${type}`;
           
           const icons = {
               success: `
                   <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center">
                       <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                       </svg>
                   </div>
               `,
               error: `
                   <div class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center">
                       <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                       </svg>
                   </div>
               `,
               warning: `
                   <div class="w-6 h-6 bg-yellow-100 rounded-full flex items-center justify-center">
                       <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                       </svg>
                   </div>
               `,
               info: `
                   <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                       <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                       </svg>
                   </div>
               `
           };
           
           toastIcon.innerHTML = icons[type] || icons.info;
           toastTitle.textContent = title;
           toastMessage.textContent = message;
           
           toast.classList.remove('hidden');
           toast.classList.add('show');
           
           // Auto-hide after 4 seconds
           setTimeout(() => {
               toast.classList.remove('show');
               setTimeout(() => {
                   toast.classList.add('hidden');
               }, 300);
           }, 4000);
       }

       // ====================================
       // ERROR HANDLING AND RECOVERY
       // ====================================
       
       window.addEventListener('error', (event) => {
           console.error('Global error:', event.error);
           
           // Don't show error toast for every script error
           if (event.error?.message?.includes('Script error')) {
               return;
           }
           
           showToast(
               'Something went wrong', 
               'Please refresh the page if issues persist', 
               'error'
           );
       });

       window.addEventListener('unhandledrejection', (event) => {
           console.error('Unhandled promise rejection:', event.reason);
           
           // Prevent default browser behavior
           event.preventDefault();
           
           showToast(
               'Network Error', 
               'Please check your connection and try again', 
               'error'
           );
       });

       // ====================================
       // PERFORMANCE OPTIMIZATIONS
       // ====================================
       
       // Throttled scroll handler for page scroll indicator
       let scrollThrottle = null;
       window.addEventListener('scroll', () => {
           if (scrollThrottle) return;
           
           scrollThrottle = setTimeout(() => {
               const scrollIndicator = document.getElementById('scroll-indicator');
               if (scrollIndicator) {
                   const scrollPercent = window.scrollY / (document.body.scrollHeight - window.innerHeight);
                   scrollIndicator.style.transform = `scaleX(${Math.min(scrollPercent, 1)})`;
               }
               scrollThrottle = null;
           }, 16); // ~60fps
       }, { passive: true });

       // Preload next batch of images when user scrolls near bottom
       let preloadThrottle = null;
       window.addEventListener('scroll', () => {
           if (preloadThrottle) return;
           
           preloadThrottle = setTimeout(() => {
               if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1000) {
                   // User is near bottom, preload more images if available
                   const unloadedImages = document.querySelectorAll('.lazy-image[data-src]:not(.loaded):not(.loading)');
                   if (unloadedImages.length > 0 && imageLoader) {
                       Array.from(unloadedImages).slice(0, 6).forEach(img => {
                           imageLoader.queueImage(img, 'normal');
                       });
                   }
               }
               preloadThrottle = null;
           }, 250);
       }, { passive: true });

       // Cleanup on page visibility change
       document.addEventListener('visibilitychange', () => {
           if (document.hidden) {
               // Clear timeouts and intervals when page is hidden
               if (scrollThrottle) {
                   clearTimeout(scrollThrottle);
                   scrollThrottle = null;
               }
               if (preloadThrottle) {
                   clearTimeout(preloadThrottle);
                   preloadThrottle = null;
               }
           }
       });

       // Memory cleanup for mobile devices
       if (getDeviceInfo().isMobile) {
           // More aggressive cleanup on mobile
           setInterval(() => {
               if (document.hidden) return;
               
               // Remove images that are far from viewport
               const images = document.querySelectorAll('.lazy-image.loaded');
               images.forEach(img => {
                   const rect = img.getBoundingClientRect();
                   const isVeryFar = Math.abs(rect.top) > window.innerHeight * 5;
                   
                   if (isVeryFar && !img.classList.contains('critical')) {
                       img.removeAttribute('src');
                       img.classList.remove('loaded');
                       img.classList.add('lazy-image');
                       
                       // Re-add to loading queue if user scrolls back
                       if (imageLoader) {
                           imageLoader.queueImage(img, 'normal');
                       }
                   }
               });
           }, 30000); // Every 30 seconds
       }

       // Service worker registration for caching (if available)
       if ('serviceWorker' in navigator) {
           window.addEventListener('load', () => {
               // Register service worker for better caching
               // This would need to be implemented separately
               console.log('üîß Service worker support detected');
           });
       }

       // Final initialization log
       console.log('üéâ Advanced Shop Profile fully loaded!');
       console.log('üì± Features: Virtual scrolling, image optimization, performance monitoring');
       console.log('üöÄ Ready for 1000+ products with smooth performance');
       
   </script>
</body>
</html>
                
